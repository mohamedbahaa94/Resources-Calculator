<html>
<head>
<title>vm_calculations.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
vm_calculations.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>

<span class="s1">modality_sizes </span><span class="s2">= {</span>
    <span class="s3">&quot;CT&quot;</span><span class="s2">: </span><span class="s4">1.0240</span><span class="s2">,</span>
    <span class="s3">&quot;MR&quot;</span><span class="s2">: </span><span class="s4">0.100</span><span class="s2">,</span>
    <span class="s3">&quot;US&quot;</span><span class="s2">: </span><span class="s4">0.010</span><span class="s2">,</span>
    <span class="s3">&quot;NM&quot;</span><span class="s2">: </span><span class="s4">0.010</span><span class="s2">,</span>
    <span class="s3">&quot;X-ray&quot;</span><span class="s2">: </span><span class="s4">0.030</span><span class="s2">,</span>
    <span class="s3">&quot;MG&quot;</span><span class="s2">: </span><span class="s4">0.16</span><span class="s2">,</span>
    <span class="s3">&quot;Cath&quot;</span><span class="s2">: </span><span class="s4">0.300</span>
<span class="s2">}</span>

<span class="s0">def </span><span class="s1">calculate_referring_physician_resources</span><span class="s2">(</span><span class="s1">ref_phys_ccu</span><span class="s2">):</span>
    <span class="s1">ccu_thresholds </span><span class="s2">= [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">48</span><span class="s2">, </span><span class="s4">64</span><span class="s2">]</span>
    <span class="s1">ram_gb_tiers </span><span class="s2">= [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">48</span><span class="s2">, </span><span class="s4">64</span><span class="s2">]</span>
    <span class="s1">vcores_tiers </span><span class="s2">= [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">]</span>
    <span class="s1">max_ccu_per_vm </span><span class="s2">= </span><span class="s4">64</span>

    <span class="s0">if </span><span class="s1">ref_phys_ccu </span><span class="s2">&lt;= </span><span class="s1">max_ccu_per_vm</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">threshold </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ccu_thresholds</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">ref_phys_ccu </span><span class="s2">&lt;= </span><span class="s1">threshold</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">num_full_vms </span><span class="s2">= </span><span class="s1">ref_phys_ccu </span><span class="s2">// </span><span class="s1">max_ccu_per_vm</span>
        <span class="s1">remaining_ccu </span><span class="s2">= </span><span class="s1">ref_phys_ccu </span><span class="s2">% </span><span class="s1">max_ccu_per_vm</span>

        <span class="s1">vm_configs </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_full_vms</span><span class="s2">):</span>
            <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s0">if </span><span class="s1">remaining_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">threshold </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ccu_thresholds</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">remaining_ccu </span><span class="s2">&lt;= </span><span class="s1">threshold</span><span class="s2">:</span>
                    <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                    <span class="s0">break</span>

        <span class="s0">return </span><span class="s1">vm_configs</span>

<span class="s0">def </span><span class="s1">calculate_vm_specifications</span><span class="s2">(</span><span class="s1">vm_type</span><span class="s2">, </span><span class="s1">num_vms</span><span class="s2">, </span><span class="s1">pacs_ccu</span><span class="s2">, </span><span class="s1">ris_ccu</span><span class="s2">, </span><span class="s1">ref_phys_ccu</span><span class="s2">, </span><span class="s1">project_grade</span><span class="s2">):</span>
    <span class="s1">vm_specs </span><span class="s2">= {</span>
        <span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;PaxeraPACS&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">16</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;PaxeraBroker&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">16</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;DBServer&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">32</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">400</span><span class="s2">},</span>
        <span class="s3">&quot;Referring Physician&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s1">vm_requirements </span><span class="s2">= {}</span>
    <span class="s1">max_ccu_per_vm </span><span class="s2">= </span><span class="s4">32</span>

    <span class="s0">def </span><span class="s1">get_vm_specs</span><span class="s2">(</span><span class="s1">ccu</span><span class="s2">, </span><span class="s1">base_ram</span><span class="s2">, </span><span class="s1">base_vcores</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">ccu </span><span class="s2">&lt;= </span><span class="s4">2</span><span class="s2">:</span>
            <span class="s1">ram </span><span class="s2">= </span><span class="s4">8</span>
            <span class="s1">vcores </span><span class="s2">= </span><span class="s4">6</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ram </span><span class="s2">= </span><span class="s1">base_ram </span><span class="s2">+ ((</span><span class="s1">ccu </span><span class="s2">- </span><span class="s4">2</span><span class="s2">) * </span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">vcores </span><span class="s2">= </span><span class="s1">base_vcores </span><span class="s2">+ ((</span><span class="s1">ccu </span><span class="s2">- </span><span class="s4">2</span><span class="s2">) // </span><span class="s4">2</span><span class="s2">) * </span><span class="s4">2</span>
        <span class="s0">return </span><span class="s1">vcores</span><span class="s2">, </span><span class="s1">ram</span>

    <span class="s0">if </span><span class="s1">vm_type </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">, </span><span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">]:</span>
        <span class="s1">ccu </span><span class="s2">= </span><span class="s1">pacs_ccu </span><span class="s0">if </span><span class="s1">vm_type </span><span class="s2">== </span><span class="s3">&quot;PaxeraUltima&quot; </span><span class="s0">else </span><span class="s1">ris_ccu</span>
        <span class="s1">vm_count </span><span class="s2">= (</span><span class="s1">ccu </span><span class="s2">+ </span><span class="s1">max_ccu_per_vm </span><span class="s2">- </span><span class="s4">1</span><span class="s2">) // </span><span class="s1">max_ccu_per_vm</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">vm_count</span><span class="s2">):</span>
            <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">vm_type</span><span class="s0">}</span><span class="s3">0</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">ccu_for_vm </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">max_ccu_per_vm</span><span class="s2">, </span><span class="s1">ccu </span><span class="s2">- </span><span class="s1">i </span><span class="s2">* </span><span class="s1">max_ccu_per_vm</span><span class="s2">)</span>
            <span class="s1">vcores</span><span class="s2">, </span><span class="s1">ram </span><span class="s2">= </span><span class="s1">get_vm_specs</span><span class="s2">(</span><span class="s1">ccu_for_vm</span><span class="s2">, </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">][</span><span class="s3">&quot;base_ram&quot;</span><span class="s2">], </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">][</span><span class="s3">&quot;vcores&quot;</span><span class="s2">])</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s1">vm_type</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">][</span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_vms</span><span class="s2">):</span>
            <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">vm_type</span><span class="s0">}</span><span class="s3">0</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">base_ram </span><span class="s2">= </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">].</span><span class="s1">get</span><span class="s2">(</span><span class="s3">&quot;base_ram&quot;</span><span class="s2">, </span><span class="s4">32</span><span class="s2">)</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s1">vm_type</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">][</span><span class="s3">&quot;vcores&quot;</span><span class="s2">],</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">base_ram</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">vm_specs</span><span class="s2">[</span><span class="s1">vm_type</span><span class="s2">][</span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">],</span>
            <span class="s2">}</span>

    <span class="s0">return </span><span class="s1">vm_requirements</span>

<span class="s0">def </span><span class="s1">calculate_dbserver_resources</span><span class="s2">(</span><span class="s1">num_studies</span><span class="s2">, </span><span class="s1">ris_ccu</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
    <span class="s1">max_studies_single_vm </span><span class="s2">= </span><span class="s4">300000</span>
    <span class="s1">db_tiers </span><span class="s2">= {</span>
        <span class="s4">5000</span><span class="s2">: (</span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">),</span>
        <span class="s4">50000</span><span class="s2">: (</span><span class="s4">10</span><span class="s2">, </span><span class="s4">32</span><span class="s2">),</span>
        <span class="s4">300000</span><span class="s2">: (</span><span class="s4">12</span><span class="s2">, </span><span class="s4">64</span><span class="s2">)</span>
    <span class="s2">}</span>

    <span class="s5"># If number of studies is zero, base the calculation on ris_ccu</span>
    <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">num_studies </span><span class="s2">= </span><span class="s1">ris_ccu </span><span class="s2">* </span><span class="s4">1250  </span><span class="s5"># Assumption: 1 ris_ccu ~ 1250 studies</span>

    <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s1">max_studies_single_vm</span><span class="s2">:</span>
        <span class="s1">prev_studies_threshold </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">prev_base_vcores</span><span class="s2">, </span><span class="s1">prev_base_ram_gb </span><span class="s2">= </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span>
        <span class="s0">for </span><span class="s1">studies_threshold</span><span class="s2">, (</span><span class="s1">base_vcores</span><span class="s2">, </span><span class="s1">base_ram_gb</span><span class="s2">) </span><span class="s0">in </span><span class="s1">db_tiers</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
            <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s1">studies_threshold</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">studies_threshold </span><span class="s2">!= </span><span class="s4">5000</span><span class="s2">:</span>
                    <span class="s1">scaling_factor </span><span class="s2">= (</span><span class="s1">num_studies </span><span class="s2">- </span><span class="s1">prev_studies_threshold</span><span class="s2">) / (</span><span class="s1">studies_threshold </span><span class="s2">- </span><span class="s1">prev_studies_threshold</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">scaling_factor </span><span class="s2">= </span><span class="s1">num_studies </span><span class="s2">/ </span><span class="s1">studies_threshold</span>
                <span class="s1">ram_gb </span><span class="s2">= </span><span class="s1">prev_base_ram_gb </span><span class="s2">+ (</span><span class="s1">base_ram_gb </span><span class="s2">- </span><span class="s1">prev_base_ram_gb</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
                <span class="s1">vcores </span><span class="s2">= </span><span class="s1">prev_base_vcores </span><span class="s2">+ (</span><span class="s1">base_vcores </span><span class="s2">- </span><span class="s1">prev_base_vcores</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
                <span class="s0">return </span><span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">ram_gb</span><span class="s2">)), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">vcores</span><span class="s2">)))]</span>
            <span class="s1">prev_studies_threshold</span><span class="s2">, </span><span class="s1">prev_base_vcores</span><span class="s2">, </span><span class="s1">prev_base_ram_gb </span><span class="s2">= </span><span class="s1">studies_threshold</span><span class="s2">, </span><span class="s1">base_vcores</span><span class="s2">, </span><span class="s1">base_ram_gb</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">vm_configs </span><span class="s2">= []</span>
        <span class="s1">remaining_studies </span><span class="s2">= </span><span class="s1">num_studies</span>
        <span class="s0">while </span><span class="s1">remaining_studies </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">vm_studies </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">max_studies_single_vm</span><span class="s2">, </span><span class="s1">remaining_studies</span><span class="s2">)</span>
            <span class="s1">remaining_studies </span><span class="s2">-= </span><span class="s1">vm_studies</span>

            <span class="s0">for </span><span class="s1">studies_threshold</span><span class="s2">, (</span><span class="s1">base_vcores</span><span class="s2">, </span><span class="s1">base_ram_gb</span><span class="s2">) </span><span class="s0">in </span><span class="s1">db_tiers</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
                <span class="s0">if </span><span class="s1">vm_studies </span><span class="s2">&lt;= </span><span class="s1">studies_threshold</span><span class="s2">:</span>
                    <span class="s1">config </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s1">base_ram_gb</span><span class="s2">, </span><span class="s1">base_vcores</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">config </span><span class="s0">not in </span><span class="s1">vm_configs</span><span class="s2">:</span>
                        <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">config</span><span class="s2">)</span>
                    <span class="s0">break</span>

        <span class="s0">return </span><span class="s1">vm_configs</span>

<span class="s0">def </span><span class="s1">calculate_paxera_ultima_resources</span><span class="s2">(</span><span class="s1">pacs_ccu</span><span class="s2">):</span>
    <span class="s1">ccu_thresholds </span><span class="s2">= [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">12</span><span class="s2">,</span><span class="s4">16</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">32</span><span class="s2">]</span>
    <span class="s1">ram_gb_tiers </span><span class="s2">= [</span><span class="s4">8</span><span class="s2">, </span><span class="s4">16</span><span class="s2">, </span><span class="s4">24</span><span class="s2">, </span><span class="s4">32</span><span class="s2">,</span><span class="s4">48</span><span class="s2">, </span><span class="s4">64</span><span class="s2">]</span>
    <span class="s1">vcores_tiers </span><span class="s2">= [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">10</span><span class="s2">,</span><span class="s4">10</span><span class="s2">, </span><span class="s4">12</span><span class="s2">]</span>
    <span class="s1">max_ccu_per_vm </span><span class="s2">= </span><span class="s4">32</span>

    <span class="s0">if </span><span class="s1">pacs_ccu </span><span class="s2">&lt;= </span><span class="s1">max_ccu_per_vm</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">threshold </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ccu_thresholds</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">pacs_ccu </span><span class="s2">&lt;= </span><span class="s1">threshold</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">num_full_vms </span><span class="s2">= </span><span class="s1">pacs_ccu </span><span class="s2">// </span><span class="s1">max_ccu_per_vm</span>
        <span class="s1">remaining_ccu </span><span class="s2">= </span><span class="s1">pacs_ccu </span><span class="s2">% </span><span class="s1">max_ccu_per_vm</span>

        <span class="s1">vm_configs </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_full_vms</span><span class="s2">):</span>
            <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]))</span>

        <span class="s0">if </span><span class="s1">remaining_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">threshold </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ccu_thresholds</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">remaining_ccu </span><span class="s2">&lt;= </span><span class="s1">threshold</span><span class="s2">:</span>
                    <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ram_gb_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">], </span><span class="s1">vcores_tiers</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]))</span>
                    <span class="s0">break</span>

        <span class="s0">return </span><span class="s1">vm_configs</span>

<span class="s0">def </span><span class="s1">calculate_paxera_pacs_resources</span><span class="s2">(</span><span class="s1">num_studies</span><span class="s2">):</span>
    <span class="s1">min_ram_gb </span><span class="s2">= </span><span class="s4">14</span>
    <span class="s1">max_ram_gb </span><span class="s2">= </span><span class="s4">48</span>
    <span class="s1">min_vcores </span><span class="s2">= </span><span class="s4">8</span>
    <span class="s1">max_vcores </span><span class="s2">= </span><span class="s4">14</span>
    <span class="s1">max_studies_per_vm </span><span class="s2">= </span><span class="s4">200000</span>

    <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s1">max_studies_per_vm</span><span class="s2">:</span>
        <span class="s1">scaling_factor </span><span class="s2">= </span><span class="s1">num_studies </span><span class="s2">/ </span><span class="s1">max_studies_per_vm</span>
        <span class="s1">ram_gb </span><span class="s2">= </span><span class="s1">min_ram_gb </span><span class="s2">+ (</span><span class="s1">max_ram_gb </span><span class="s2">- </span><span class="s1">min_ram_gb</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
        <span class="s1">vcores </span><span class="s2">= </span><span class="s1">min_vcores </span><span class="s2">+ (</span><span class="s1">max_vcores </span><span class="s2">- </span><span class="s1">min_vcores</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
        <span class="s0">return </span><span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">ram_gb</span><span class="s2">)), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">vcores</span><span class="s2">)))]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">num_full_vms </span><span class="s2">= </span><span class="s1">num_studies </span><span class="s2">// </span><span class="s1">max_studies_per_vm</span>
        <span class="s1">remaining_studies </span><span class="s2">= </span><span class="s1">num_studies </span><span class="s2">% </span><span class="s1">max_studies_per_vm</span>

        <span class="s1">vm_configs </span><span class="s2">= []</span>

        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_full_vms</span><span class="s2">):</span>
            <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">max_ram_gb</span><span class="s2">, </span><span class="s1">max_vcores</span><span class="s2">))</span>

        <span class="s0">if </span><span class="s1">remaining_studies </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
            <span class="s1">scaling_factor </span><span class="s2">= </span><span class="s1">remaining_studies </span><span class="s2">/ </span><span class="s1">max_studies_per_vm</span>
            <span class="s1">ram_gb </span><span class="s2">= </span><span class="s1">min_ram_gb </span><span class="s2">+ (</span><span class="s1">max_ram_gb </span><span class="s2">- </span><span class="s1">min_ram_gb</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
            <span class="s1">vcores </span><span class="s2">= </span><span class="s1">min_vcores </span><span class="s2">+ (</span><span class="s1">max_vcores </span><span class="s2">- </span><span class="s1">min_vcores</span><span class="s2">) * </span><span class="s1">scaling_factor</span>
            <span class="s1">vm_configs</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">ram_gb</span><span class="s2">)), </span><span class="s1">int</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">vcores</span><span class="s2">))))</span>

        <span class="s0">return </span><span class="s1">vm_configs</span>

<span class="s0">def </span><span class="s1">calculate_vm_requirements</span><span class="s2">(</span>
    <span class="s1">num_studies</span><span class="s2">,</span>
    <span class="s1">pacs_ccu</span><span class="s2">,</span>
    <span class="s1">ris_ccu</span><span class="s2">,</span>
    <span class="s1">ref_phys_ccu</span><span class="s2">,</span>
    <span class="s1">project_grade</span><span class="s2">,</span>
    <span class="s1">broker_required</span><span class="s2">,</span>
    <span class="s1">broker_level</span><span class="s2">,</span>
    <span class="s1">num_machines</span><span class="s2">,</span>
    <span class="s1">contract_duration</span><span class="s2">,</span>
    <span class="s1">study_size_mb</span><span class="s2">,</span>
    <span class="s1">annual_growth_rate</span><span class="s2">,</span>
    <span class="s1">breakdown_per_modality</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">aidocker_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">ark_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">u9_ai_features</span><span class="s2">=</span><span class="s0">None</span><span class="s2">,  </span><span class="s5"># Updated: Add dynamic U9.AI feature handling</span>
    <span class="s1">ref_phys_external_access</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">patient_portal_ccu</span><span class="s2">=</span><span class="s4">0</span><span class="s2">,</span>
    <span class="s1">patient_portal_external_access</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">training_vm_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">high_availability</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s1">combine_pacs_ris</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">**</span><span class="s1">modality_cases</span>
<span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Calculates the VM requirements for a medical imaging solution. 
    Incorporates dynamic handling of AI features and other system components. 
    &quot;&quot;&quot;</span>

    <span class="s1">vm_specs </span><span class="s2">= {</span>
        <span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;PaxeraPACS&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">16</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
        <span class="s3">&quot;DBServer&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">32</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">400</span><span class="s2">},</span>
        <span class="s3">&quot;Referring Physician&quot;</span><span class="s2">: {</span><span class="s3">&quot;vcores&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;base_ram&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">, </span><span class="s3">&quot;storage_gb&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s1">vms_needed </span><span class="s2">= {</span>
        <span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">: </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s4">0</span><span class="s2">,</span>
        <span class="s3">&quot;DBServer&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
        <span class="s3">&quot;PaxeraBroker&quot;</span><span class="s2">: </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">broker_required </span><span class="s0">else </span><span class="s4">0</span><span class="s2">,</span>
        <span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">: </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s4">0</span><span class="s2">,</span>
        <span class="s3">&quot;Referring Physician&quot;</span><span class="s2">: </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">ref_phys_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">ref_phys_external_access </span><span class="s0">else </span><span class="s4">0</span><span class="s2">,</span>
        <span class="s3">&quot;Patient Portal&quot;</span><span class="s2">: </span><span class="s4">1 </span><span class="s0">if </span><span class="s1">patient_portal_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">patient_portal_external_access </span><span class="s0">else </span><span class="s4">0</span><span class="s2">,  </span><span class="s5"># Add this line</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s1">breakdown_per_modality</span><span class="s2">:</span>
        <span class="s1">total_cases </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">modality_cases</span><span class="s2">.</span><span class="s1">values</span><span class="s2">())</span>
        <span class="s1">total_storage </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">modality_cases</span><span class="s2">[</span><span class="s1">modality</span><span class="s2">] * </span><span class="s1">modality_sizes</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">modality</span><span class="s2">, </span><span class="s4">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">modality </span><span class="s0">in </span><span class="s1">modality_cases</span><span class="s2">)</span>
        <span class="s1">average_study_size </span><span class="s2">= </span><span class="s1">total_storage </span><span class="s2">/ </span><span class="s1">total_cases </span><span class="s0">if </span><span class="s1">total_cases </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s4">0</span>
        <span class="s1">image_storage_raid5_modality </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">modality_cases</span><span class="s2">[</span><span class="s1">modality</span><span class="s2">] * </span><span class="s1">modality_sizes</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">modality</span><span class="s2">, </span><span class="s4">0</span><span class="s2">) * </span><span class="s1">contract_duration </span><span class="s0">for </span><span class="s1">modality </span><span class="s0">in </span><span class="s1">modality_cases</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">total_cases </span><span class="s2">= </span><span class="s1">num_studies</span>
        <span class="s1">average_study_size </span><span class="s2">= </span><span class="s1">study_size_mb</span>
        <span class="s1">image_storage_raid5_modality </span><span class="s2">= </span><span class="s1">num_studies </span><span class="s2">* </span><span class="s1">average_study_size </span><span class="s2">* </span><span class="s1">contract_duration </span><span class="s2">* (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">)</span>

    <span class="s1">vm_requirements </span><span class="s2">= {}</span>
    <span class="s1">vm_config_lists </span><span class="s2">= {</span>
        <span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">: </span><span class="s1">calculate_paxera_ultima_resources</span><span class="s2">(</span><span class="s1">pacs_ccu</span><span class="s2">) </span><span class="s0">if </span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s2">[],</span>
        <span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">: </span><span class="s1">calculate_paxera_ultima_resources</span><span class="s2">(</span><span class="s1">ris_ccu</span><span class="s2">) </span><span class="s0">if </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">else </span><span class="s2">[],</span>
        <span class="s3">&quot;Referring Physician&quot;</span><span class="s2">: </span><span class="s1">calculate_referring_physician_resources</span><span class="s2">(</span>
            <span class="s1">ref_phys_ccu</span><span class="s2">) </span><span class="s0">if </span><span class="s1">ref_phys_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">ref_phys_external_access </span><span class="s0">else </span><span class="s2">[],</span>
        <span class="s3">&quot;Patient Portal&quot;</span><span class="s2">: </span><span class="s1">calculate_referring_physician_resources</span><span class="s2">(</span>
            <span class="s1">patient_portal_ccu</span><span class="s2">) </span><span class="s0">if </span><span class="s1">patient_portal_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">patient_portal_external_access </span><span class="s0">else </span><span class="s2">[]  </span><span class="s5"># Add this line</span>
    <span class="s2">}</span>

    <span class="s0">for </span><span class="s1">vm_type</span><span class="s2">, </span><span class="s1">config_list </span><span class="s0">in </span><span class="s1">vm_config_lists</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">num_vms</span><span class="s2">, </span><span class="s1">ram_gb</span><span class="s2">, </span><span class="s1">vcores</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">config_list</span><span class="s2">):</span>
            <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">vm_type</span><span class="s0">}{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s1">vm_type</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">,</span>
            <span class="s2">}</span>

    <span class="s1">dbserver_vm_configs </span><span class="s2">= </span><span class="s1">calculate_dbserver_resources</span><span class="s2">(</span><span class="s1">num_studies</span><span class="s2">,</span><span class="s1">ris_ccu</span><span class="s2">)</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">ram_gb</span><span class="s2">, </span><span class="s1">vcores </span><span class="s2">= </span><span class="s1">dbserver_vm_configs</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">] = {</span>
        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;DBServer&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">400</span>
    <span class="s2">}</span>

    <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">pacs_vm_configs </span><span class="s2">= </span><span class="s1">calculate_paxera_pacs_resources</span><span class="s2">(</span><span class="s1">num_studies</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, (</span><span class="s1">num_vms</span><span class="s2">, </span><span class="s1">ram_gb</span><span class="s2">, </span><span class="s1">vcores</span><span class="s2">) </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">pacs_vm_configs</span><span class="s2">):</span>
            <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;PaxeraPACS</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s1">vm_name</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">,</span>
            <span class="s2">}</span>
    <span class="s0">if </span><span class="s1">combine_pacs_ris </span><span class="s0">and </span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s5"># Filter all PaxeraUltima and PaxeraRIS VMs</span>
        <span class="s1">ultima_vms </span><span class="s2">= [</span><span class="s1">vm </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">vm_requirements </span><span class="s0">if </span><span class="s1">vm</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">)]</span>
        <span class="s1">ris_vms </span><span class="s2">= [</span><span class="s1">vm </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">vm_requirements </span><span class="s0">if </span><span class="s1">vm</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">)]</span>

        <span class="s1">combined_vms </span><span class="s2">= []</span>
        <span class="s1">num_combined_vms </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ultima_vms</span><span class="s2">), </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ris_vms</span><span class="s2">))  </span><span class="s5"># Take the larger number of VMs</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">num_combined_vms</span><span class="s2">):</span>
            <span class="s5"># Handle combining corresponding VMs or use only one if the other is missing</span>
            <span class="s1">ultima_vm </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ultima_vms</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ultima_vms</span><span class="s2">) </span><span class="s0">else None</span>
            <span class="s1">ris_vm </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">ris_vms</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) </span><span class="s0">if </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ris_vms</span><span class="s2">) </span><span class="s0">else None</span>

            <span class="s0">if </span><span class="s1">ultima_vm </span><span class="s0">and </span><span class="s1">ris_vm</span><span class="s2">:</span>
                <span class="s5"># Combine the corresponding VMs, taking the maximum of their specs</span>
                <span class="s1">combined_vm </span><span class="s2">= {</span>
                    <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;PaxeraUltima/PaxeraRIS&quot;</span><span class="s2">,</span>
                    <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">max</span><span class="s2">(</span><span class="s1">ultima_vm</span><span class="s2">[</span><span class="s3">&quot;vCores&quot;</span><span class="s2">], </span><span class="s1">ris_vm</span><span class="s2">[</span><span class="s3">&quot;vCores&quot;</span><span class="s2">]),</span>
                    <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">max</span><span class="s2">(</span><span class="s1">ultima_vm</span><span class="s2">[</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">], </span><span class="s1">ris_vm</span><span class="s2">[</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">]),</span>
                    <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">max</span><span class="s2">(</span><span class="s1">ultima_vm</span><span class="s2">[</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">], </span><span class="s1">ris_vm</span><span class="s2">[</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">]),</span>
                <span class="s2">}</span>
            <span class="s0">elif </span><span class="s1">ultima_vm</span><span class="s2">:</span>
                <span class="s5"># Use only the Ultima VM specs if RIS VM is missing</span>
                <span class="s1">combined_vm </span><span class="s2">= </span><span class="s1">ultima_vm</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">combined_vm</span><span class="s2">[</span><span class="s3">&quot;VM Type&quot;</span><span class="s2">] = </span><span class="s3">&quot;PaxeraUltima/PaxeraRIS&quot;</span>
            <span class="s0">elif </span><span class="s1">ris_vm</span><span class="s2">:</span>
                <span class="s5"># Use only the RIS VM specs if Ultima VM is missing</span>
                <span class="s1">combined_vm </span><span class="s2">= </span><span class="s1">ris_vm</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
                <span class="s1">combined_vm</span><span class="s2">[</span><span class="s3">&quot;VM Type&quot;</span><span class="s2">] = </span><span class="s3">&quot;PaxeraUltima/PaxeraRIS&quot;</span>

            <span class="s1">combined_vms</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">combined_vm</span><span class="s2">)</span>

        <span class="s5"># Remove the original Ultima and RIS VMs</span>
        <span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">ultima_vms </span><span class="s2">+ </span><span class="s1">ris_vms</span><span class="s2">:</span>
            <span class="s1">vm_requirements</span><span class="s2">.</span><span class="s1">pop</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)</span>

        <span class="s5"># Add the combined VMs to the requirements</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">combined_vm </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">combined_vms</span><span class="s2">, </span><span class="s1">start</span><span class="s2">=</span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">combined_vm_name </span><span class="s2">= </span><span class="s3">f&quot;PaxeraUltima/RIS</span><span class="s0">{</span><span class="s1">i</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;  </span><span class="s5"># Ensure consistent naming with incrementing numbers</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">combined_vm_name</span><span class="s2">] = </span><span class="s1">combined_vm</span>

        <span class="s5"># Disable the separate VM types in `vms_needed`</span>
        <span class="s1">vms_needed</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima&quot;</span><span class="s2">] = </span><span class="s4">0</span>
        <span class="s1">vms_needed</span><span class="s2">[</span><span class="s3">&quot;PaxeraRIS&quot;</span><span class="s2">] = </span><span class="s4">0</span>

    <span class="s5"># Broker VM Logic with Project Grades</span>
    <span class="s5"># Broker VM Logic with Project Grades</span>
    <span class="s0">if </span><span class="s1">broker_required </span><span class="s0">or </span><span class="s2">(</span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">):</span>
        <span class="s5"># Determine the number of modalities</span>
        <span class="s1">modalities </span><span class="s2">= </span><span class="s1">num_machines </span><span class="s0">if </span><span class="s1">broker_required </span><span class="s0">else </span><span class="s1">num_machines</span>

        <span class="s5"># Calculate the number of Broker VMs (1 Broker per 10 modalities)</span>
        <span class="s1">broker_vms </span><span class="s2">= (</span><span class="s1">modalities </span><span class="s2">+ </span><span class="s4">9</span><span class="s2">) // </span><span class="s4">10</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">broker_vms</span><span class="s2">):</span>
            <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;PaxeraBroker</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;</span>

            <span class="s5"># Define VM specs based on broker level</span>
            <span class="s0">if </span><span class="s1">broker_level </span><span class="s2">== </span><span class="s3">&quot;HL7 Unidirectional&quot;</span><span class="s2">:</span>
                <span class="s1">vm_type </span><span class="s2">= </span><span class="s3">&quot;PaxeraBroker HL7 Unidirectional&quot;</span>
                <span class="s1">vcores </span><span class="s2">= </span><span class="s4">8</span>
                <span class="s1">ram_gb </span><span class="s2">= </span><span class="s4">16</span>
            <span class="s0">elif </span><span class="s1">broker_level </span><span class="s2">== </span><span class="s3">&quot;HL7 Bidirectional&quot;</span><span class="s2">:</span>
                <span class="s1">vm_type </span><span class="s2">= </span><span class="s3">&quot;PaxeraBroker HL7 Bidirectional&quot;</span>
                <span class="s1">vcores </span><span class="s2">= </span><span class="s4">10</span>
                <span class="s1">ram_gb </span><span class="s2">= </span><span class="s4">24</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">vm_type </span><span class="s2">= </span><span class="s3">&quot;PaxeraBroker WL&quot;</span>
                <span class="s1">vcores </span><span class="s2">= </span><span class="s4">6</span>
                <span class="s1">ram_gb </span><span class="s2">= </span><span class="s4">12</span>

            <span class="s1">storage_gb </span><span class="s2">= </span><span class="s4">150  </span><span class="s5"># Fixed storage per broker</span>

            <span class="s0">if </span><span class="s1">project_grade </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">] </span><span class="s0">and </span><span class="s1">i </span><span class="s2">== </span><span class="s4">0 </span><span class="s0">and </span><span class="s3">&quot;DBServer01&quot; </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">:</span>
                <span class="s5"># Combine first broker with DBServer in Grade 1 &amp; 2</span>
                <span class="s1">db_vcores </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">]</span>
                <span class="s1">db_ram </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">]</span>
                <span class="s1">db_storage </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">]</span>

                <span class="s1">combined_vcores </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s4">12</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">db_vcores </span><span class="s2">+ </span><span class="s1">vcores</span><span class="s2">) / </span><span class="s4">1.2 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">))</span>
                <span class="s1">combined_ram </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s4">64</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">db_ram </span><span class="s2">+ </span><span class="s1">ram_gb</span><span class="s2">) / </span><span class="s4">1.2 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">))</span>
                <span class="s1">combined_storage </span><span class="s2">= </span><span class="s1">db_storage </span><span class="s2">+ </span><span class="s1">storage_gb</span>

                <span class="s5"># Update DBServer to include broker resources with explicit broker type</span>
                <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">] = {</span>
                    <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">f&quot;DBServer/Broker (</span><span class="s0">{</span><span class="s1">vm_type</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">,  </span><span class="s5"># Explicitly include the Broker type</span>
                    <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">combined_vcores</span><span class="s2">,</span>
                    <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">combined_ram</span><span class="s2">,</span>
                    <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">combined_storage</span><span class="s2">,</span>
                <span class="s2">}</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># Add as standalone Broker VM</span>
                <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = {</span>
                    <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s1">vm_type</span><span class="s2">,</span>
                    <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                    <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
                    <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">storage_gb</span><span class="s2">,</span>
                <span class="s2">}</span>

    <span class="s5"># Referring Physician VM Logic</span>
    <span class="s0">if not </span><span class="s1">ref_phys_external_access </span><span class="s0">and </span><span class="s1">ref_phys_ccu </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">ref_phys_vm_resources </span><span class="s2">= </span><span class="s1">calculate_referring_physician_resources</span><span class="s2">(</span><span class="s1">ref_phys_ccu</span><span class="s2">)</span>
        <span class="s1">max_vcores_per_vm </span><span class="s2">= </span><span class="s4">12  </span><span class="s5"># Example threshold for vCores</span>
        <span class="s1">max_ram_per_vm </span><span class="s2">= </span><span class="s4">64  </span><span class="s5"># Example threshold for RAM in GB</span>

        <span class="s0">for </span><span class="s1">num_vms</span><span class="s2">, </span><span class="s1">ram_gb</span><span class="s2">, </span><span class="s1">vcores </span><span class="s0">in </span><span class="s1">ref_phys_vm_resources</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">combine_pacs_ris</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s3">&quot;PaxeraUltima/RIS01&quot; </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">:</span>
                    <span class="s1">current_vcores </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima/RIS01&quot;</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">]</span>
                    <span class="s1">current_ram </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima/RIS01&quot;</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">]</span>
                    <span class="s1">new_vcores </span><span class="s2">= </span><span class="s1">current_vcores </span><span class="s2">+ </span><span class="s1">vcores</span>
                    <span class="s1">new_ram </span><span class="s2">= </span><span class="s1">current_ram </span><span class="s2">+ </span><span class="s1">ram_gb</span>

                    <span class="s0">if </span><span class="s1">new_vcores </span><span class="s2">&gt; </span><span class="s1">max_vcores_per_vm </span><span class="s0">or </span><span class="s1">new_ram </span><span class="s2">&gt; </span><span class="s1">max_ram_per_vm</span><span class="s2">:</span>
                        <span class="s1">new_vm_name </span><span class="s2">= </span><span class="s3">f&quot;PaxeraUltima/RIS</span><span class="s0">{</span><span class="s1">len</span><span class="s2">(</span><span class="s1">vm_requirements</span><span class="s2">) + </span><span class="s4">1</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;</span>
                        <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">new_vm_name</span><span class="s2">] = {</span>
                            <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;PaxeraUltima/RIS&quot;</span><span class="s2">,</span>
                            <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                            <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
                            <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">,</span>
                        <span class="s2">}</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima/RIS01&quot;</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] = </span><span class="s1">new_vcores</span>
                        <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima/RIS01&quot;</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] = </span><span class="s1">new_ram</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima/RIS01&quot;</span><span class="s2">] = {</span>
                        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;PaxeraUltima/RIS&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">vcores</span><span class="s2">,</span>
                        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">ram_gb</span><span class="s2">,</span>
                        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">150</span><span class="s2">,</span>
                    <span class="s2">}</span>

    <span class="s5"># Project Grades Logic</span>
    <span class="s0">if </span><span class="s1">project_grade </span><span class="s2">== </span><span class="s4">1</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s3">&quot;PaxeraPACS01&quot; </span><span class="s0">in </span><span class="s1">vm_requirements </span><span class="s0">and </span><span class="s3">&quot;PaxeraUltima01&quot; </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">:</span>
            <span class="s1">combined_vm </span><span class="s2">= {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;PaxeraPACS/PaxeraUltima&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraPACS01&quot;</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] + </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima01&quot;</span><span class="s2">][</span>
                    <span class="s3">&quot;vCores&quot;</span><span class="s2">]) / </span><span class="s4">1.2 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">),</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraPACS01&quot;</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] + </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima01&quot;</span><span class="s2">][</span>
                    <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">]) / </span><span class="s4">1.2 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">),</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraPACS01&quot;</span><span class="s2">][</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">]</span>
            <span class="s2">}</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraPACS01&quot;</span><span class="s2">] = </span><span class="s1">combined_vm</span>
            <span class="s0">del </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;PaxeraUltima01&quot;</span><span class="s2">]</span>

    <span class="s0">elif </span><span class="s1">project_grade </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">broker_required </span><span class="s0">and </span><span class="s3">&quot;DBServer01&quot; </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">:</span>
            <span class="s1">combined_vm </span><span class="s2">= {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">f&quot;DBServer/Broker (</span><span class="s0">{</span><span class="s1">vm_type</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s1">min</span><span class="s2">(</span><span class="s4">12</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] + </span><span class="s4">8</span><span class="s2">) / </span><span class="s4">1.5 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">)),</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s1">min</span><span class="s2">(</span><span class="s4">64</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">((</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] + </span><span class="s4">16</span><span class="s2">) / </span><span class="s4">1.5 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">)),</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">][</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">] + </span><span class="s4">150</span><span class="s2">,</span>
            <span class="s2">}</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;DBServer01&quot;</span><span class="s2">] = </span><span class="s1">combined_vm</span>

    <span class="s0">elif </span><span class="s1">project_grade </span><span class="s2">== </span><span class="s4">3</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">vm_name</span><span class="s2">, </span><span class="s1">specs </span><span class="s0">in </span><span class="s1">list</span><span class="s2">(</span><span class="s1">vm_requirements</span><span class="s2">.</span><span class="s1">items</span><span class="s2">()):</span>
            <span class="s0">if </span><span class="s1">specs</span><span class="s2">[</span><span class="s3">&quot;VM Type&quot;</span><span class="s2">] != </span><span class="s3">&quot;PaxeraPACS&quot;</span><span class="s2">:</span>
                <span class="s1">specs</span><span class="s2">[</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] = </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">(</span><span class="s1">specs</span><span class="s2">[</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] * </span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">)</span>
                <span class="s1">specs</span><span class="s2">[</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] = </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">round</span><span class="s2">(</span><span class="s1">specs</span><span class="s2">[</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] * </span><span class="s4">1 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">broker_required</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">broker_vms</span><span class="s2">):</span>
                <span class="s1">vm_name </span><span class="s2">= </span><span class="s3">f&quot;PaxeraBroker</span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s4">1</span><span class="s0">:</span><span class="s3">02d</span><span class="s0">}</span><span class="s3">&quot;</span>
                <span class="s0">if </span><span class="s1">vm_name </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">:</span>
                    <span class="s1">broker_specs </span><span class="s2">= </span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">()</span>
                    <span class="s1">broker_specs</span><span class="s2">[</span><span class="s3">&quot;VM Type&quot;</span><span class="s2">] = </span><span class="s1">vm_type</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">] = </span><span class="s1">broker_specs</span>

    <span class="s1">df_results </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">()</span>
    <span class="s1">total_image_storage_raid5 </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">first_year_storage_raid5 </span><span class="s2">= (</span><span class="s1">num_studies </span><span class="s2">* </span><span class="s1">study_size_mb </span><span class="s2">* (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">)) / </span><span class="s4">1024</span>
    <span class="s1">current_studies </span><span class="s2">= </span><span class="s1">num_studies</span>
    <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">contract_duration</span><span class="s2">):</span>
        <span class="s1">image_storage_raid5 </span><span class="s2">= (</span><span class="s1">current_studies </span><span class="s2">* </span><span class="s1">study_size_mb </span><span class="s2">* (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">)) / </span><span class="s4">1024</span>
        <span class="s1">total_image_storage_raid5 </span><span class="s2">+= </span><span class="s1">image_storage_raid5</span>
        <span class="s1">current_studies </span><span class="s2">*= (</span><span class="s4">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s4">100</span><span class="s2">)</span>
    <span class="s1">total_image_storage_raid5 </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">total_image_storage_raid5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
    <span class="s1">first_year_storage_raid5 </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span><span class="s1">first_year_storage_raid5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>

    <span class="s1">total_vcpu </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">][</span><span class="s3">&quot;vCores&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">vm_name </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">])</span>
    <span class="s1">total_ram </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">][</span><span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">vm_name </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">])</span>
    <span class="s1">total_storage </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">([</span><span class="s1">vm_requirements</span><span class="s2">[</span><span class="s1">vm_name</span><span class="s2">][</span><span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">vm_name </span><span class="s0">in </span><span class="s1">vm_requirements</span><span class="s2">])</span>

    <span class="s0">if </span><span class="s1">vm_requirements</span><span class="s2">:</span>
        <span class="s1">df_results </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_dict</span><span class="s2">(</span><span class="s1">vm_requirements</span><span class="s2">, </span><span class="s1">orient</span><span class="s2">=</span><span class="s3">'index'</span><span class="s2">)</span>
        <span class="s5"># Initialize AI Docker-specific VMs if U9.AI is included</span>
        <span class="s0">if </span><span class="s1">aidocker_included </span><span class="s0">and </span><span class="s1">u9_ai_features</span><span class="s2">:</span>
            <span class="s0">for </span><span class="s1">feature </span><span class="s0">in </span><span class="s1">u9_ai_features</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">feature </span><span class="s2">== </span><span class="s3">&quot;Organ Segmentator&quot;</span><span class="s2">:</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;OrganSegmentator&quot;</span><span class="s2">] = {</span>
                        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;Organ Segmentator Docker&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">,</span>
                        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">48</span><span class="s2">,</span>
                        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">100</span>
                    <span class="s2">}</span>
                    <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">12</span>
                    <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">48</span>
                    <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">100</span>
                <span class="s0">elif </span><span class="s1">feature </span><span class="s2">== </span><span class="s3">&quot;Lesion Segmentator 2D&quot;</span><span class="s2">:</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;LesionSegmentator2D&quot;</span><span class="s2">] = {</span>
                        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;Lesion Segmentator 2D Docker&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">,</span>
                        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">,</span>
                        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">50</span>
                    <span class="s2">}</span>
                    <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">4</span>
                    <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">8</span>
                    <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">50</span>
                <span class="s0">elif </span><span class="s1">feature </span><span class="s2">== </span><span class="s3">&quot;Lesion Segmentator 3D&quot;</span><span class="s2">:</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;LesionSegmentator3D&quot;</span><span class="s2">] = {</span>
                        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;Lesion Segmentator 3D Docker&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">6</span><span class="s2">,</span>
                        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">8</span><span class="s2">,</span>
                        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">50</span>
                    <span class="s2">}</span>
                    <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">6</span>
                    <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">8</span>
                    <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">50</span>
                <span class="s0">elif </span><span class="s1">feature </span><span class="s2">== </span><span class="s3">&quot;Speech-to-text Container&quot;</span><span class="s2">:</span>
                    <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;SpeechToText&quot;</span><span class="s2">] = {</span>
                        <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;Speech-to-text Docker&quot;</span><span class="s2">,</span>
                        <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">,</span>
                        <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">4</span><span class="s2">,</span>
                        <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">50</span>
                    <span class="s2">}</span>
                    <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">4</span>
                    <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">4</span>
                    <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">50</span>

        <span class="s0">if </span><span class="s1">ark_included</span><span class="s2">:</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;AIARKManager01&quot;</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;AI ARK Manager&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">,</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">32</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">100</span>
            <span class="s2">}</span>
            <span class="s1">vm_requirements</span><span class="s2">[</span><span class="s3">&quot;AIARKLAB01&quot;</span><span class="s2">] = {</span>
                <span class="s3">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s3">&quot;AI ARK LAB&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;vCores&quot;</span><span class="s2">: </span><span class="s4">12</span><span class="s2">,</span>
                <span class="s3">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s4">32</span><span class="s2">,</span>
                <span class="s3">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s4">300</span>
            <span class="s2">}</span>
            <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">12</span>
            <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">32</span>
            <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">300</span>


            <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s4">12</span>
            <span class="s1">total_ram </span><span class="s2">+= </span><span class="s4">32</span>
            <span class="s1">total_storage </span><span class="s2">+= </span><span class="s4">100</span>

        <span class="s1">df_results </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_dict</span><span class="s2">(</span><span class="s1">vm_requirements</span><span class="s2">, </span><span class="s1">orient</span><span class="s2">=</span><span class="s3">'index'</span><span class="s2">)</span>

        <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;Total&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_vcpu</span><span class="s2">, </span><span class="s1">total_ram</span><span class="s2">, </span><span class="s1">total_storage</span><span class="s2">]</span>
        <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;RAID 1 (SSD)&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_storage</span><span class="s2">]</span>
        <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;RAID 5 (HDD)&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_image_storage_raid5</span><span class="s2">]</span>

    <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s4">50000</span><span class="s2">:</span>
        <span class="s1">sql_license </span><span class="s2">= </span><span class="s3">&quot;SQL Express&quot;</span>
    <span class="s0">elif </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s4">500000</span><span class="s2">:</span>
        <span class="s1">sql_license </span><span class="s2">= </span><span class="s3">&quot;SQL Standard&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">sql_license </span><span class="s2">= </span><span class="s3">&quot;SQL Enterprise&quot;</span>


    <span class="s1">df_results </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_dict</span><span class="s2">(</span><span class="s1">vm_requirements</span><span class="s2">, </span><span class="s1">orient</span><span class="s2">=</span><span class="s3">'index'</span><span class="s2">)</span>
    <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;Total&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_vcpu</span><span class="s2">, </span><span class="s1">total_ram</span><span class="s2">, </span><span class="s1">total_storage</span><span class="s2">]</span>
    <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;RAID 1 (SSD)&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_storage</span><span class="s2">]</span>
    <span class="s1">df_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">&quot;RAID 5 (HDD)&quot;</span><span class="s2">] = [</span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">total_image_storage_raid5</span><span class="s2">]</span>

    <span class="s0">return </span><span class="s1">df_results</span><span class="s2">, </span><span class="s1">sql_license</span><span class="s2">, </span><span class="s1">first_year_storage_raid5</span><span class="s2">, </span><span class="s1">total_image_storage_raid5</span><span class="s2">, </span><span class="s1">total_vcpu</span><span class="s2">, </span><span class="s1">total_ram</span><span class="s2">, </span><span class="s1">total_storage</span>
</pre>
</body>
</html>