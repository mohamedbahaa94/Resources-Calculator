<html>
<head>
<title>main.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">logging</span>
<span class="s0">import </span><span class="s1">math</span>
<span class="s0">from </span><span class="s1">PIL </span><span class="s0">import </span><span class="s1">Image</span>
<span class="s0">import </span><span class="s1">streamlit </span><span class="s0">as </span><span class="s1">st</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">document_generator </span><span class="s0">import </span><span class="s1">generate_document_from_template</span><span class="s2">, </span><span class="s1">get_binary_file_downloader_html</span>
<span class="s0">from </span><span class="s1">vm_calculations </span><span class="s0">import </span><span class="s1">calculate_vm_requirements</span><span class="s2">, </span><span class="s1">modality_sizes</span>

<span class="s1">logging</span><span class="s2">.</span><span class="s1">basicConfig</span><span class="s2">(</span><span class="s1">level</span><span class="s2">=</span><span class="s1">logging</span><span class="s2">.</span><span class="s1">INFO</span><span class="s2">)</span>

<span class="s0">def </span><span class="s1">add_server</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">, </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span><span class="s2">, </span><span class="s1">max_threads</span><span class="s2">, </span><span class="s1">max_ram</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">remaining_threads </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">remaining_ram </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span>

    <span class="s1">print</span><span class="s2">(</span><span class="s4">f&quot;Entering add_server with remaining_threads=</span><span class="s0">{</span><span class="s1">remaining_threads</span><span class="s0">} </span><span class="s4">and remaining_ram=</span><span class="s0">{</span><span class="s1">remaining_ram</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s5"># Calculate the number of servers needed</span>
    <span class="s1">num_servers_threads </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">remaining_threads </span><span class="s2">/ </span><span class="s1">max_threads</span><span class="s2">)</span>
    <span class="s1">num_servers_ram </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">remaining_ram </span><span class="s2">/ </span><span class="s1">max_ram</span><span class="s2">)</span>
    <span class="s1">num_servers </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">num_servers_threads</span><span class="s2">, </span><span class="s1">num_servers_ram</span><span class="s2">)</span>

    <span class="s5"># Uniform allocation for threads and RAM</span>
    <span class="s1">threads_per_server </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">remaining_threads </span><span class="s2">/ </span><span class="s1">num_servers</span><span class="s2">)</span>
    <span class="s1">ram_per_server </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">remaining_ram </span><span class="s2">/ </span><span class="s1">num_servers</span><span class="s2">)</span>

    <span class="s5"># Ensure threads are divisible by 2</span>
    <span class="s1">threads_per_server </span><span class="s2">-= </span><span class="s1">threads_per_server </span><span class="s2">% </span><span class="s3">2</span>

    <span class="s5"># Allocate resources for the current server</span>
    <span class="s0">if </span><span class="s1">threads_per_server </span><span class="s2">&gt; </span><span class="s3">128</span><span class="s2">:</span>
        <span class="s1">processors_to_allocate </span><span class="s2">= </span><span class="s4">'Dual'</span>
        <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">threads_per_server </span><span class="s2">/ </span><span class="s3">4</span><span class="s2">), </span><span class="s3">64</span><span class="s2">)</span>
        <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">cores_per_processor </span><span class="s0">if </span><span class="s1">cores_per_processor </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s1">cores_per_processor </span><span class="s2">+ </span><span class="s3">1</span>
        <span class="s1">total_cores </span><span class="s2">= </span><span class="s1">cores_per_processor </span><span class="s2">* </span><span class="s3">2</span>
        <span class="s1">total_threads </span><span class="s2">= </span><span class="s1">total_cores </span><span class="s2">* </span><span class="s3">2</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">threads_per_server </span><span class="s2">&gt; </span><span class="s3">20</span><span class="s2">:</span>
            <span class="s1">processors_to_allocate </span><span class="s2">= </span><span class="s4">'Dual'</span>
            <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">threads_per_server </span><span class="s2">/ </span><span class="s3">4</span><span class="s2">), </span><span class="s3">64</span><span class="s2">)</span>
            <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">cores_per_processor </span><span class="s0">if </span><span class="s1">cores_per_processor </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s1">cores_per_processor </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">total_cores </span><span class="s2">= </span><span class="s1">cores_per_processor </span><span class="s2">* </span><span class="s3">2</span>
            <span class="s1">total_threads </span><span class="s2">= </span><span class="s1">total_cores </span><span class="s2">* </span><span class="s3">2</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">processors_to_allocate </span><span class="s2">= </span><span class="s4">'Single'</span>
            <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">min</span><span class="s2">(</span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span><span class="s1">threads_per_server </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">), </span><span class="s3">64</span><span class="s2">)</span>
            <span class="s1">cores_per_processor </span><span class="s2">= </span><span class="s1">cores_per_processor </span><span class="s0">if </span><span class="s1">cores_per_processor </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">else </span><span class="s1">cores_per_processor </span><span class="s2">+ </span><span class="s3">1</span>
            <span class="s1">total_cores </span><span class="s2">= </span><span class="s1">cores_per_processor</span>
            <span class="s1">total_threads </span><span class="s2">= </span><span class="s1">total_cores </span><span class="s2">* </span><span class="s3">2</span>

    <span class="s1">servers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
        <span class="s4">&quot;Processors&quot;</span><span class="s2">: </span><span class="s1">processors_to_allocate</span><span class="s2">,</span>
        <span class="s4">&quot;Total Cores&quot;</span><span class="s2">: </span><span class="s1">total_cores</span><span class="s2">,</span>
        <span class="s4">&quot;Total Threads&quot;</span><span class="s2">: </span><span class="s1">total_threads</span><span class="s2">,</span>
        <span class="s4">&quot;Cores per Processor&quot;</span><span class="s2">: </span><span class="s1">cores_per_processor</span><span class="s2">,</span>
        <span class="s4">&quot;Threads per Processor&quot;</span><span class="s2">: </span><span class="s1">total_threads </span><span class="s2">// (</span><span class="s3">2 </span><span class="s0">if </span><span class="s1">processors_to_allocate </span><span class="s2">== </span><span class="s4">'Dual' </span><span class="s0">else </span><span class="s3">1</span><span class="s2">),</span>
        <span class="s4">&quot;RAM&quot;</span><span class="s2">: </span><span class="s1">ram_per_server</span>
    <span class="s2">})</span>

    <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span>
        <span class="s4">f&quot;Allocated Server: Processors=</span><span class="s0">{</span><span class="s1">processors_to_allocate</span><span class="s0">}</span><span class="s4">, Total Cores=</span><span class="s0">{</span><span class="s1">total_cores</span><span class="s0">}</span><span class="s4">, Total Threads=</span><span class="s0">{</span><span class="s1">total_threads</span><span class="s0">}</span><span class="s4">, RAM=</span><span class="s0">{</span><span class="s1">ram_per_server</span><span class="s0">} </span><span class="s4">GB&quot;</span><span class="s2">)</span>
    <span class="s1">print</span><span class="s2">(</span>
        <span class="s4">f&quot;Allocated Server: Processors=</span><span class="s0">{</span><span class="s1">processors_to_allocate</span><span class="s0">}</span><span class="s4">, Total Cores=</span><span class="s0">{</span><span class="s1">total_cores</span><span class="s0">}</span><span class="s4">, Total Threads=</span><span class="s0">{</span><span class="s1">total_threads</span><span class="s0">}</span><span class="s4">, RAM=</span><span class="s0">{</span><span class="s1">ram_per_server</span><span class="s0">} </span><span class="s4">GB&quot;</span><span class="s2">)</span>

    <span class="s5"># Update remaining resources</span>
    <span class="s1">remaining_threads </span><span class="s2">-= </span><span class="s1">threads_per_server</span>
    <span class="s1">remaining_ram </span><span class="s2">-= </span><span class="s1">ram_per_server</span>

    <span class="s5"># Ensure no negative values</span>
    <span class="s1">remaining_threads </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>
    <span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">max</span><span class="s2">(</span><span class="s1">remaining_ram</span><span class="s2">, </span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span>

<span class="s0">def </span><span class="s1">format_server_specs</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">, </span><span class="s1">base_name</span><span class="s2">=</span><span class="s4">&quot;Server&quot;</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Format server specifications for display with dynamic naming. 
 
    Args: 
        servers (list): List of server dictionaries containing specs. 
        base_name (str): Base name for the servers (e.g., &quot;Test Server&quot;, &quot;Management Server&quot;). 
 
    Returns: 
        str: Formatted server specifications as a string. 
    &quot;&quot;&quot;</span>
    <span class="s1">server_specs </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">server </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">):</span>
        <span class="s5"># Dynamically assign server name</span>
        <span class="s1">server_name </span><span class="s2">= </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">base_name</span><span class="s0">} {</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">1</span><span class="s0">}</span><span class="s4">&quot;</span>
        <span class="s1">server_specs </span><span class="s2">+= </span><span class="s4">f&quot;&quot;&quot;</span>
        <span class="s4">**</span><span class="s0">{</span><span class="s1">server_name</span><span class="s0">}</span><span class="s4">:**</span>
          <span class="s4">- Processors: </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'Processors'</span><span class="s2">]</span><span class="s0">}</span>
          <span class="s4">- Total CPU: </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'Total Cores'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">Cores / </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'Total Threads'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">Threads</span>
          <span class="s4">- Per Processor: </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'Cores per Processor'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">Cores / </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'Threads per Processor'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">Threads</span>
          <span class="s4">- RAM: </span><span class="s0">{</span><span class="s1">server</span><span class="s2">[</span><span class="s4">'RAM'</span><span class="s2">]</span><span class="s0">} </span><span class="s4">GB</span>
        <span class="s4">&quot;&quot;&quot;</span>
    <span class="s0">return </span><span class="s1">server_specs</span>
<span class="s0">def </span><span class="s1">calculate_raid5_disks</span><span class="s2">(</span><span class="s1">usable_storage_tb</span><span class="s2">, </span><span class="s1">min_disks</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">max_disks</span><span class="s2">=</span><span class="s3">24</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Calculate the optimal RAID 5 disk configuration for the given usable storage requirements. 
 
    Args: 
        usable_storage_tb (float): The required usable storage in terabytes (TB). 
        min_disks (int): The minimum number of disks in the RAID 5 array (default is 3). 
        max_disks (int): The maximum number of disks in the RAID 5 array (default is 24). 
 
    Returns: 
        (int, float): A tuple containing the total number of disks and the size of each disk in TB. 
                      Returns (None, None) if no valid configuration is found. 
    &quot;&quot;&quot;</span>
    <span class="s1">available_disk_sizes_tb </span><span class="s2">= </span><span class="s1">sorted</span><span class="s2">([ </span><span class="s3">1.5</span><span class="s2">,</span><span class="s3">2.4</span><span class="s2">,</span><span class="s3">3</span><span class="s2">,</span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">12</span><span class="s2">, </span><span class="s3">16</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">22</span><span class="s2">], </span><span class="s1">reverse</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">best_total_disks </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">best_disk_size </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">smallest_excess </span><span class="s2">= </span><span class="s1">float</span><span class="s2">(</span><span class="s4">'inf'</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">disk_size </span><span class="s0">in </span><span class="s1">available_disk_sizes_tb</span><span class="s2">:</span>
        <span class="s0">for </span><span class="s1">total_disks </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">min_disks</span><span class="s2">, </span><span class="s1">max_disks </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">usable_storage_with_disks </span><span class="s2">= (</span><span class="s1">total_disks </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) * </span><span class="s1">disk_size  </span><span class="s5"># RAID 5 formula</span>

            <span class="s5"># Check if the configuration meets the required storage</span>
            <span class="s0">if </span><span class="s1">usable_storage_with_disks </span><span class="s2">&gt;= </span><span class="s1">usable_storage_tb</span><span class="s2">:</span>
                <span class="s1">excess_storage </span><span class="s2">= </span><span class="s1">usable_storage_with_disks </span><span class="s2">- </span><span class="s1">usable_storage_tb</span>

                <span class="s5"># Add a penalty for using more disks to prioritize fewer disks</span>
                <span class="s1">penalty </span><span class="s2">= </span><span class="s1">excess_storage </span><span class="s2">+ </span><span class="s3">0.01 </span><span class="s2">* </span><span class="s1">total_disks</span>

                <span class="s5"># Update the best configuration if this configuration is better</span>
                <span class="s0">if </span><span class="s1">penalty </span><span class="s2">&lt; </span><span class="s1">smallest_excess</span><span class="s2">:</span>
                    <span class="s1">smallest_excess </span><span class="s2">= </span><span class="s1">penalty</span>
                    <span class="s1">best_total_disks </span><span class="s2">= </span><span class="s1">total_disks</span>
                    <span class="s1">best_disk_size </span><span class="s2">= </span><span class="s1">disk_size</span>

    <span class="s5"># Return the best configuration</span>
    <span class="s0">return </span><span class="s1">best_total_disks</span><span class="s2">, </span><span class="s1">best_disk_size</span>
<span class="s5"># Test the optimized function with an input of 18 TB usable storage</span>


<span class="s0">def </span><span class="s1">round_to_nearest_divisible_by_two</span><span class="s2">(</span><span class="s1">value</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">round</span><span class="s2">(</span><span class="s1">value </span><span class="s2">/ </span><span class="s3">2</span><span class="s2">) * </span><span class="s3">2</span>


<span class="s0">def </span><span class="s1">format_number_with_commas</span><span class="s2">(</span><span class="s1">number</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">number</span><span class="s0">:</span><span class="s4">,</span><span class="s0">}</span><span class="s4">&quot;</span>


<span class="s0">def </span><span class="s1">main</span><span class="s2">():</span>
    <span class="s1">app_dir </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">))</span>
    <span class="s1">logo_image </span><span class="s2">= </span><span class="s1">Image</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">app_dir</span><span class="s2">, </span><span class="s4">&quot;assets&quot;</span><span class="s2">, </span><span class="s4">&quot;logo.png&quot;</span><span class="s2">))</span>

    <span class="s1">col1</span><span class="s2">, </span><span class="s1">col2</span><span class="s2">, </span><span class="s1">col3 </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">1</span><span class="s2">])</span>
    <span class="s0">with </span><span class="s1">col1</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">col2</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">image</span><span class="s2">(</span><span class="s1">logo_image</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">col3</span><span class="s2">:</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">)</span>

    <span class="s1">st</span><span class="s2">.</span><span class="s1">title</span><span class="s2">(</span><span class="s4">&quot;PaxeraHealth Sizing Calculator&quot;</span><span class="s2">)</span>
    <span class="s1">customer_name </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">text_input</span><span class="s2">(</span><span class="s4">&quot;Customer Name:&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;Project and Location Details&quot;</span><span class="s2">):</span>
        <span class="s1">num_machines </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Number of Machines (Modalities):&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s1">num_locations </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Number of Locations:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s1">breakdown_per_modality </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">radio</span><span class="s2">(</span><span class="s4">&quot;Breakdown per Modality?&quot;</span><span class="s2">, [</span><span class="s4">&quot;No&quot;</span><span class="s2">, </span><span class="s4">&quot;Yes&quot;</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">breakdown_per_modality </span><span class="s2">== </span><span class="s4">&quot;No&quot;</span><span class="s2">:</span>
            <span class="s1">num_studies </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Number of studies per year:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">100000</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>

            <span class="s5"># Display the number of studies in green with commas</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">metric</span><span class="s2">(</span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;Number of Studies&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">num_studies</span><span class="s0">:</span><span class="s4">,</span><span class="s0">} </span><span class="s4">studies&quot;</span><span class="s2">, </span><span class="s1">delta</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">delta_color</span><span class="s2">=</span><span class="s4">&quot;off&quot;</span><span class="s2">)</span>
            <span class="s1">modality_cases </span><span class="s2">= {}</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Modality Breakdown:&quot;</span><span class="s2">)</span>
            <span class="s1">modality_cases </span><span class="s2">= {</span>
                <span class="s4">&quot;CT&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;CT Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;MR&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;MR Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;US&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;US Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;NM&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;NM Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;X-ray&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;X-ray Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;MG&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;MG Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
                <span class="s4">&quot;Cath&quot;</span><span class="s2">: </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Cath Cases:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">),</span>
            <span class="s2">}</span>
            <span class="s1">num_studies </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">modality_cases</span><span class="s2">.</span><span class="s1">values</span><span class="s2">())</span>

        <span class="s1">contract_duration </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Contract Duration (years):&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s1">study_size_mb </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Study Size (MB):&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">100</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s1">annual_growth_rate </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Annual Growth Rate (%):&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0.0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">10.0</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%f&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;Project Grade&quot;</span><span class="s2">):</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
          &lt;style&gt; 
          .tooltip { 
              position: relative; 
              display: inline-block; 
              cursor: pointer; 
          } 
 
          .tooltip .tooltiptext { 
              visibility: hidden; 
              width: 220px; 
              background-color: #555; 
              color: #fff; 
              text-align: center; 
              border-radius: 6px; 
              padding: 5px 0; 
              position: absolute; 
              z-index: 1; 
              bottom: 125%; 
              left: 50%; 
              margin-left: -110px; 
              opacity: 0; 
              transition: opacity 0.3s; 
          } 
 
          .tooltip:hover .tooltiptext { 
              visibility: visible; 
              opacity: 1; 
          } 
          &lt;/style&gt; 
          &quot;&quot;&quot;</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s3">50000</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span>
                <span class="s4">&quot;Project Grade: &lt;span class='tooltip'&gt;ℹ️&lt;span class='tooltiptext'&gt;Select the appropriate project grade based on the volume of studies. Grade 1 is for lower volume (up to 50,000), Grade 2 for medium volume (50,000 to 150,000), and Grade 3 for high volume (more than 150,000).&lt;/span&gt;&lt;/span&gt;&quot;</span><span class="s2">,</span>
                <span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">project_grade </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">, [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">elif </span><span class="s3">50000 </span><span class="s2">&lt; </span><span class="s1">num_studies </span><span class="s2">&lt;= </span><span class="s3">150000</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span>
                <span class="s4">&quot;Project Grade: &lt;span class='tooltip'&gt;ℹ️&lt;span class='tooltiptext'&gt;Select the appropriate project grade based on the volume of studies. Grade 1 is for lower volume (up to 50,000), Grade 2 for medium volume (50,000 to 150,000), and Grade 3 for high volume (more than 150,000).&lt;/span&gt;&lt;/span&gt;&quot;</span><span class="s2">,</span>
                <span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">project_grade </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span>
                <span class="s4">&quot;Project Grade: &lt;span class='tooltip'&gt;ℹ️&lt;span class='tooltiptext'&gt;Select the appropriate project grade based on the volume of studies. Grade 1 is for lower volume (up to 50,000), Grade 2 for medium volume (50,000 to 150,000), and Grade 3 for high volume (more than 150,000).&lt;/span&gt;&lt;/span&gt;&quot;</span><span class="s2">,</span>
                <span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">project_grade </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">&quot;&quot;</span><span class="s2">, [</span><span class="s3">3</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;CCU Details&quot;</span><span class="s2">):</span>
        <span class="s1">pacs_enabled </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include PACS&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">pacs_enabled</span><span class="s2">:</span>
            <span class="s1">pacs_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;PACS CCU:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">8</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pacs_ccu </span><span class="s2">= </span><span class="s3">0</span>

        <span class="s1">ris_enabled </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include RIS&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ris_enabled</span><span class="s2">:</span>
            <span class="s1">ris_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;RIS CCU:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">8</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ris_ccu </span><span class="s2">= </span><span class="s3">0</span>
        <span class="s1">combine_pacs_ris </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s0">if </span><span class="s1">pacs_enabled </span><span class="s0">and </span><span class="s1">ris_enabled </span><span class="s0">and </span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
            <span class="s1">combine_pacs_ris </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Combine PACS and RIS VMs&quot;</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">combine_pacs_ris</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;Combining PACS and RIS VMs will use shared resources for both systems.&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">combine_pacs_ris </span><span class="s2">= </span><span class="s0">False  </span><span class="s5"># Default to False if conditions are not met</span>

        <span class="s1">ref_phys_enabled </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include Referring Physician&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">ref_phys_enabled</span><span class="s2">:</span>
            <span class="s1">ref_phys_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Referring Physician CCU:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">8</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
            <span class="s1">ref_phys_external_access </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;External Access for Referring Physician Portal&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">ref_phys_ccu </span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">ref_phys_external_access </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">patient_portal_enabled </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include Patient Portal&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">patient_portal_enabled</span><span class="s2">:</span>
            <span class="s1">patient_portal_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span><span class="s4">&quot;Patient Portal CCU:&quot;</span><span class="s2">, </span><span class="s1">min_value</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">8</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;%d&quot;</span><span class="s2">)</span>
            <span class="s1">patient_portal_external_access </span><span class="s2">= </span><span class="s0">True</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">patient_portal_ccu</span><span class="s2">= </span><span class="s3">0</span>
            <span class="s1">patient_portal_external_access </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;Business Continuity &amp; Gateway&quot;</span><span class="s2">):</span>
        <span class="s1">location_details </span><span class="s2">= []</span>
        <span class="s1">mini_pacs_settings </span><span class="s2">= []</span>
        <span class="s1">gateway_locations </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">, </span><span class="s1">num_locations </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">):</span>
            <span class="s1">location_type </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span>
                <span class="s4">f&quot;Select interconnection type for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                <span class="s2">[</span><span class="s4">&quot;Gateway Uploader&quot;</span><span class="s2">, </span><span class="s4">&quot;Business Continuity Mini PACS&quot;</span><span class="s2">]</span>
            <span class="s2">)</span>

            <span class="s0">if </span><span class="s1">location_type </span><span class="s2">== </span><span class="s4">&quot;Business Continuity Mini PACS&quot;</span><span class="s2">:</span>
                <span class="s1">mini_pacs_num_studies </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">f&quot;Number of studies per year for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">, [</span><span class="s3">5000</span><span class="s2">, </span><span class="s3">10000</span><span class="s2">, </span><span class="s3">15000</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">format_func</span><span class="s2">=</span><span class="s1">format_number_with_commas</span><span class="s2">)</span>
                <span class="s1">mini_pacs_pacs_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">f&quot;PACS CCU for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">, [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">mini_pacs_ris_enabled </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">f&quot;Enable RIS for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">mini_pacs_ris_enabled</span><span class="s2">:</span>
                    <span class="s1">mini_pacs_ris_ccu </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">selectbox</span><span class="s2">(</span><span class="s4">f&quot;RIS CCU for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">, [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">mini_pacs_ris_ccu </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">mini_pacs_broker_level </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">radio</span><span class="s2">(</span><span class="s4">f&quot;Broker Level for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">, [</span><span class="s4">&quot;Not Required&quot;</span><span class="s2">, </span><span class="s4">&quot;WL&quot;</span><span class="s2">, </span><span class="s4">&quot;HL7 Unidirectional&quot;</span><span class="s2">, </span><span class="s4">&quot;HL7 Bidirectional&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
                <span class="s1">mini_pacs_high_availability </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">f&quot;High Availability HW Design Required for Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

                <span class="s1">mini_pacs_settings</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
                    <span class="s4">&quot;location&quot;</span><span class="s2">: </span><span class="s4">f&quot;Location </span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;num_studies&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_num_studies</span><span class="s2">,</span>
                    <span class="s4">&quot;pacs_ccu&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_pacs_ccu</span><span class="s2">,</span>
                    <span class="s4">&quot;ris_enabled&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_ris_enabled</span><span class="s2">,</span>
                    <span class="s4">&quot;ris_ccu&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_ris_ccu</span><span class="s2">,</span>
                    <span class="s4">&quot;broker_level&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_broker_level</span><span class="s2">,</span>
                    <span class="s4">&quot;high_availability&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_high_availability</span>
                <span class="s2">})</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">gateway_locations</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>

            <span class="s1">location_details</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">location_type</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;Broker Details&quot;</span><span class="s2">):</span>
        <span class="s1">broker_required </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Broker VM Required (check if explicitly requested)&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">broker_required</span><span class="s2">:</span>
            <span class="s1">broker_level </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">radio</span><span class="s2">(</span><span class="s4">&quot;Broker Level:&quot;</span><span class="s2">, [</span><span class="s4">&quot;WL&quot;</span><span class="s2">, </span><span class="s4">&quot;HL7 Unidirectional&quot;</span><span class="s2">, </span><span class="s4">&quot;HL7 Bidirectional&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">broker_level </span><span class="s2">= </span><span class="s4">&quot;Not Required&quot;</span>
    <span class="s5"># Initialize AI module variables</span>
    <span class="s1">organ_segmentator </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">lesion_segmentator_2d </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">lesion_segmentator_3d </span><span class="s2">= </span><span class="s0">False</span>
    <span class="s1">speech_to_text_container </span><span class="s2">= </span><span class="s0">False</span>

    <span class="s5"># AI Features Section</span>
    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;AI Features&quot;</span><span class="s2">):</span>
        <span class="s5"># U9.Ai Features</span>
        <span class="s1">aidocker_included </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span>
            <span class="s4">&quot;Include U9th Integrated AI modules&quot;</span><span class="s2">,</span>
            <span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">disabled</span><span class="s2">=(</span><span class="s1">num_studies </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s2">)</span>

        <span class="s0">if </span><span class="s1">aidocker_included</span><span class="s2">:</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;#### U9th AI Modules&quot;</span><span class="s2">)</span>
            <span class="s1">organ_segmentator </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Organ Segmentator&quot;</span><span class="s2">)</span>
            <span class="s1">lesion_segmentator_2d </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 2D&quot;</span><span class="s2">)</span>
            <span class="s1">lesion_segmentator_3d </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 3D&quot;</span><span class="s2">)</span>
            <span class="s1">speech_to_text_container </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Speech-to-text Container&quot;</span><span class="s2">)</span>

        <span class="s5"># ARKAI</span>
        <span class="s1">ark_included </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span>
            <span class="s4">&quot;Include ARKAI&quot;</span><span class="s2">,</span>
            <span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">disabled</span><span class="s2">=(</span><span class="s1">num_studies </span><span class="s2">== </span><span class="s3">0</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s5"># High Availability Selection Section</span>
    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;High Availability Design Options&quot;</span><span class="s2">):</span>
        <span class="s5"># General HA Design</span>
        <span class="s1">high_availability </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Enable High Availability on Hardware Level (Host, Server, Storage)&quot;</span><span class="s2">,</span>
                                        <span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">high_availability_vms </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Enable High Availability on VM Level&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s5"># Hardware and Design Features Section</span>
    <span class="s0">with </span><span class="s1">st</span><span class="s2">.</span><span class="s1">expander</span><span class="s2">(</span><span class="s4">&quot;Hardware and Design Features&quot;</span><span class="s2">):</span>
        <span class="s1">training_vm_included </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include Testing/Training VM&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s5"># NAS Backup Options</span>
        <span class="s1">use_nas_backup </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include NAS Storage for Backup&quot;</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">use_nas_backup</span><span class="s2">:</span>
            <span class="s5"># Redundancy factor input</span>
            <span class="s1">nas_redundancy_factor </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span>
                <span class="s4">&quot;NAS Redundancy Factor (e.g., 1.5 for 50% extra storage):&quot;</span><span class="s2">,</span>
                <span class="s1">min_value</span><span class="s2">=</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">value</span><span class="s2">=</span><span class="s3">1.5</span><span class="s2">, </span><span class="s1">step</span><span class="s2">=</span><span class="s3">0.1</span>
            <span class="s2">)</span>

            <span class="s5"># Duration input for NAS storage backup</span>
            <span class="s1">nas_backup_years </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">number_input</span><span class="s2">(</span>
                <span class="s4">&quot;Number of Years for NAS Storage Backup:&quot;</span><span class="s2">,</span>
                <span class="s1">min_value</span><span class="s2">=</span><span class="s1">contract_duration</span><span class="s2">,  </span><span class="s5"># Minimum value is the contract period</span>
                <span class="s1">value</span><span class="s2">=</span><span class="s1">contract_duration</span><span class="s2">,  </span><span class="s5"># Default to contract period</span>
                <span class="s1">step</span><span class="s2">=</span><span class="s3">1</span>
            <span class="s2">)</span>

        <span class="s5"># Intermediate/Short-Term Storage Options</span>
        <span class="s1">include_fast_tier_storage </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span>
            <span class="s4">&quot;Include High-Performance Tier for Short-Term Image Storage (e.g., SSD or High-Speed SATA)&quot;</span>
        <span class="s2">)</span>
        <span class="s1">fast_tier_duration </span><span class="s2">= </span><span class="s0">None  </span><span class="s5"># Initialize variable</span>
        <span class="s0">if </span><span class="s1">include_fast_tier_storage</span><span class="s2">:</span>
            <span class="s1">fast_tier_duration </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">radio</span><span class="s2">(</span>
                <span class="s4">&quot;Select Duration for High-Performance Tier Storage:&quot;</span><span class="s2">,</span>
                <span class="s1">options</span><span class="s2">=[</span><span class="s4">&quot;6 Months&quot;</span><span class="s2">, </span><span class="s4">&quot;1 Year&quot;</span><span class="s2">],</span>
                <span class="s1">index</span><span class="s2">=</span><span class="s3">0</span>
            <span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">fast_tier_duration </span><span class="s2">= </span><span class="s4">&quot;Not Selected&quot;  </span><span class="s5"># Set default value if not selected</span>

        <span class="s5"># Workstation Specifications</span>
        <span class="s1">include_workstation_specs </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">checkbox</span><span class="s2">(</span><span class="s4">&quot;Include Workstation Specifications&quot;</span><span class="s2">)</span>


    <span class="s1">calculate </span><span class="s2">= </span><span class="s1">st</span><span class="s2">.</span><span class="s1">button</span><span class="s2">(</span><span class="s4">&quot;Calculate&quot;</span><span class="s2">)</span>

    <span class="s5"># Validation check</span>
    <span class="s0">if </span><span class="s1">calculate</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s2">(</span>
                <span class="s1">num_studies </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">pacs_ccu </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">== </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">ref_phys_ccu </span><span class="s2">== </span><span class="s3">0</span>
                <span class="s0">and not </span><span class="s1">pacs_enabled </span><span class="s0">and not </span><span class="s1">ris_enabled </span><span class="s0">and not </span><span class="s1">ref_phys_enabled</span>
                <span class="s0">and not </span><span class="s1">broker_required </span><span class="s0">and not </span><span class="s1">aidocker_included </span><span class="s0">and not </span><span class="s1">ark_included</span>
                <span class="s0">and not </span><span class="s1">high_availability </span><span class="s0">and not </span><span class="s1">training_vm_included</span>
        <span class="s2">):</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">error</span><span class="s2">(</span><span class="s4">&quot;Please enter values for the number of studies, CCUs, or select additional features.&quot;</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Starting VM Requirements Calculation&quot;</span><span class="s2">)</span>
            <span class="s1">start_calc_time </span><span class="s2">= </span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">()</span>
            <span class="s1">results</span><span class="s2">, </span><span class="s1">sql_license</span><span class="s2">, </span><span class="s1">first_year_storage_raid5</span><span class="s2">, </span><span class="s1">total_image_storage_raid5</span><span class="s2">, </span><span class="s1">total_vcpu</span><span class="s2">, </span><span class="s1">total_ram</span><span class="s2">, </span><span class="s1">total_storage </span><span class="s2">= </span><span class="s1">calculate_vm_requirements</span><span class="s2">(</span>
                <span class="s1">num_studies</span><span class="s2">=</span><span class="s1">num_studies</span><span class="s2">,</span>
                <span class="s1">pacs_ccu</span><span class="s2">=</span><span class="s1">pacs_ccu</span><span class="s2">,</span>
                <span class="s1">ris_ccu</span><span class="s2">=</span><span class="s1">ris_ccu</span><span class="s2">,</span>
                <span class="s1">ref_phys_ccu</span><span class="s2">=</span><span class="s1">ref_phys_ccu</span><span class="s2">,</span>
                <span class="s1">project_grade</span><span class="s2">=</span><span class="s1">project_grade</span><span class="s2">,</span>
                <span class="s1">broker_required</span><span class="s2">=</span><span class="s1">broker_required</span><span class="s2">,</span>
                <span class="s1">broker_level</span><span class="s2">=</span><span class="s1">broker_level</span><span class="s2">,</span>
                <span class="s1">num_machines</span><span class="s2">=</span><span class="s1">num_machines</span><span class="s2">,</span>
                <span class="s1">contract_duration</span><span class="s2">=</span><span class="s1">contract_duration</span><span class="s2">,</span>
                <span class="s1">study_size_mb</span><span class="s2">=</span><span class="s1">study_size_mb</span><span class="s2">,</span>
                <span class="s1">annual_growth_rate</span><span class="s2">=</span><span class="s1">annual_growth_rate</span><span class="s2">,</span>
                <span class="s1">breakdown_per_modality</span><span class="s2">=</span><span class="s1">breakdown_per_modality</span><span class="s2">,</span>
                <span class="s1">aidocker_included</span><span class="s2">=</span><span class="s1">aidocker_included</span><span class="s2">,</span>
                <span class="s1">ark_included</span><span class="s2">=</span><span class="s1">ark_included</span><span class="s2">,</span>
                <span class="s1">u9_ai_features</span><span class="s2">=[  </span><span class="s5"># Updated: Dynamic U9.AI feature list</span>
                    <span class="s4">&quot;Organ Segmentator&quot; </span><span class="s0">if </span><span class="s1">organ_segmentator </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 2D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_2d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 3D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_3d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Speech-to-text Container&quot; </span><span class="s0">if </span><span class="s1">speech_to_text_container </span><span class="s0">else None</span>
                <span class="s2">],</span>
                <span class="s1">ref_phys_external_access</span><span class="s2">=</span><span class="s1">ref_phys_external_access</span><span class="s2">,</span>
                <span class="s1">patient_portal_ccu</span><span class="s2">=</span><span class="s1">patient_portal_ccu</span><span class="s2">,</span>
                <span class="s1">patient_portal_external_access</span><span class="s2">=</span><span class="s1">patient_portal_external_access</span><span class="s2">,</span>
                <span class="s1">training_vm_included</span><span class="s2">=</span><span class="s1">training_vm_included</span><span class="s2">,</span>
                <span class="s1">high_availability</span><span class="s2">=</span><span class="s1">high_availability</span><span class="s2">,</span>
                <span class="s1">combine_pacs_ris</span><span class="s2">=</span><span class="s1">combine_pacs_ris</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">modality_cases</span>
            <span class="s2">)</span>

            <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">f&quot;VM Requirements Calculation completed in </span><span class="s0">{</span><span class="s1">time</span><span class="s2">.</span><span class="s1">time</span><span class="s2">() - </span><span class="s1">start_calc_time</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">seconds&quot;</span><span class="s2">)</span>

            <span class="s0">if not </span><span class="s1">results</span><span class="s2">.</span><span class="s1">empty</span><span class="s2">:</span>
                <span class="s5"># 🛡️ Set default Operating System and Other Software</span>
                <span class="s1">results</span><span class="s2">[</span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;Windows Server 2019 or Higher&quot;</span>
                <span class="s1">results</span><span class="s2">[</span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>

                <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">results</span><span class="s2">.</span><span class="s1">index</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s4">&quot;TestVM&quot; </span><span class="s0">in </span><span class="s1">index</span><span class="s2">:</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s1">sql_license</span>
                    <span class="s0">if </span><span class="s4">&quot;DBServer&quot; </span><span class="s0">in </span><span class="s1">index</span><span class="s2">:</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s1">sql_license</span>

                    <span class="s5"># Update for specific AI Segmentation Dockers</span>
                    <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">name </span><span class="s0">in </span><span class="s1">index </span><span class="s0">for </span><span class="s1">name </span><span class="s0">in</span>
                           <span class="s2">[</span><span class="s4">&quot;OrganSegmentator&quot;</span><span class="s2">, </span><span class="s4">&quot;LesionSegmentator2D&quot;</span><span class="s2">, </span><span class="s4">&quot;LesionSegmentator3D&quot;</span><span class="s2">, </span><span class="s4">&quot;SpeechToText&quot;</span><span class="s2">]):</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;Ubuntu 20.4&quot;</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span>
                            <span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;Nvidia Driver version 450.80.02 or higher</span><span class="s0">\n</span><span class="s4">Nvidia driver to support CUDA version 11.4 or higher&quot;</span>

                    <span class="s5"># Update for ARK Lab</span>
                    <span class="s0">if </span><span class="s4">&quot;AIARKLAB&quot; </span><span class="s0">in </span><span class="s1">index</span><span class="s2">:</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;Ubuntu 20.4&quot;</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span>
                            <span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;Nvidia Driver version 450.80.02 or higher</span><span class="s0">\n</span><span class="s4">Nvidia driver to support CUDA version 11.4 or higher&quot;</span>

                    <span class="s5"># Special case for ARK Manager</span>
                    <span class="s0">if </span><span class="s4">&quot;AIARKManager&quot; </span><span class="s0">in </span><span class="s1">index</span><span class="s2">:</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;Windows Server 2019 or Higher&quot;</span>
                        <span class="s1">results</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>

            <span class="s1">display_results </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">([</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;RAID 5 (HDD)&quot;</span><span class="s2">])</span>

            <span class="s1">last_index </span><span class="s2">= </span><span class="s1">display_results</span><span class="s2">.</span><span class="s1">tail</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">index</span>
            <span class="s1">display_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">last_index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>
            <span class="s1">display_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">last_index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;VM Recommendations:&quot;</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">display_results</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
                <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">'background-color: yellow' </span><span class="s0">if </span><span class="s4">'Test Environment VM' </span><span class="s0">in </span><span class="s1">x</span><span class="s2">.</span><span class="s1">name </span><span class="s0">else </span><span class="s4">'' </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">x</span><span class="s2">],</span>
                <span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">2</span><span class="s2">))</span>

            <span class="s5"># 🛠️ Prepare Additional VMs</span>
            <span class="s1">additional_vms </span><span class="s2">= []</span>

            <span class="s5"># Add Test Environment VM</span>
            <span class="s0">if </span><span class="s1">training_vm_included</span><span class="s2">:</span>
                <span class="s1">test_vm_specs </span><span class="s2">= {</span>
                    <span class="s4">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s4">&quot;Test Environment VM (Ultima, PACS, Broker)&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;vCores&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">,</span>
                    <span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s3">0</span><span class="s2">,</span>
                    <span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s3">150</span><span class="s2">,</span>
                    <span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">: </span><span class="s3">0</span>
                <span class="s2">}</span>
                <span class="s0">if </span><span class="s1">sql_license </span><span class="s2">== </span><span class="s4">&quot;SQL Express&quot;</span><span class="s2">:</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;vCores&quot;</span><span class="s2">] = </span><span class="s3">8</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">] = </span><span class="s3">16</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">] = </span><span class="s3">1.0</span>
                <span class="s0">elif </span><span class="s1">sql_license </span><span class="s2">== </span><span class="s4">&quot;SQL Standard&quot;</span><span class="s2">:</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;vCores&quot;</span><span class="s2">] = </span><span class="s3">10</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">] = </span><span class="s3">32</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">] = </span><span class="s3">5.0</span>
                <span class="s0">elif </span><span class="s1">sql_license </span><span class="s2">== </span><span class="s4">&quot;SQL Enterprise&quot;</span><span class="s2">:</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;vCores&quot;</span><span class="s2">] = </span><span class="s3">12</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">] = </span><span class="s3">64</span>
                    <span class="s1">test_vm_specs</span><span class="s2">[</span><span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">] = </span><span class="s3">10.0</span>

                <span class="s1">additional_vms</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">test_vm_specs</span><span class="s2">)</span>

            <span class="s5"># Add Management VM for High Availability</span>
            <span class="s0">if </span><span class="s1">high_availability</span><span class="s2">:</span>
                <span class="s1">management_vm_specs </span><span class="s2">= {</span>
                    <span class="s4">&quot;VM Type&quot;</span><span class="s2">: </span><span class="s4">&quot;Management VM (Backup, Antivirus, vCenter)&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;vCores&quot;</span><span class="s2">: </span><span class="s3">8</span><span class="s2">,</span>
                    <span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">: </span><span class="s3">32 </span><span class="s0">if </span><span class="s1">sql_license </span><span class="s0">in </span><span class="s2">[</span><span class="s4">&quot;SQL Express&quot;</span><span class="s2">, </span><span class="s4">&quot;SQL Standard&quot;</span><span class="s2">] </span><span class="s0">else </span><span class="s3">64</span><span class="s2">,</span>
                    <span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">: </span><span class="s3">150</span><span class="s2">,</span>
                    <span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">: </span><span class="s3">0</span>
                <span class="s2">}</span>
                <span class="s1">additional_vms</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">management_vm_specs</span><span class="s2">)</span>

            <span class="s5"># Prepare Additional VMs Table</span>
            <span class="s0">if </span><span class="s1">additional_vms</span><span class="s2">:</span>
                <span class="s1">additional_vms_table </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">additional_vms</span><span class="s2">)</span>

                <span class="s0">if </span><span class="s4">&quot;VM Type&quot; </span><span class="s0">in </span><span class="s1">additional_vms_table</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s4">&quot;Total&quot; </span><span class="s0">in </span><span class="s1">additional_vms_table</span><span class="s2">[</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">].</span><span class="s1">values</span><span class="s2">:</span>
                        <span class="s1">total_row_index </span><span class="s2">= </span><span class="s1">additional_vms_table</span><span class="s2">[</span><span class="s1">additional_vms_table</span><span class="s2">[</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">] == </span><span class="s4">&quot;Total&quot;</span><span class="s2">].</span><span class="s1">index</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]</span>
                        <span class="s1">additional_vms_table</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">total_row_index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>
                        <span class="s1">additional_vms_table</span><span class="s2">.</span><span class="s1">at</span><span class="s2">[</span><span class="s1">total_row_index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">additional_vms_table </span><span class="s2">= </span><span class="s0">None</span>


    
            <span class="s1">additional_vm_notes </span><span class="s2">= []</span>
            <span class="s5"># Display Additional VMs Table and Notes</span>
            <span class="s0">if </span><span class="s1">additional_vms</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Additional VMs:&quot;</span><span class="s2">)</span>
                <span class="s1">additional_vms_table </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">additional_vms</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">table</span><span class="s2">(</span><span class="s1">additional_vms_table</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">2</span><span class="s2">))</span>

                <span class="s5"># Display Notes for Additional VMs</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Additional VM Notes:&quot;</span><span class="s2">)</span>

                <span class="s5"># Test Environment VM Note</span>
                <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">[</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">] == </span><span class="s4">&quot;Test Environment VM (Ultima, PACS, Broker)&quot; </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">):</span>
                    <span class="s1">additional_vm_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
                - **Test Environment VM:**   
                  - It is recommended to host this VM on a **separate hardware pool** dedicated for testing and training purposes.   
                    This ensures that production workloads are not impacted by testing or training activities. 
                    &quot;&quot;&quot;</span><span class="s2">)</span>

                <span class="s5"># Management VM Note</span>
                <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">[</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">] == </span><span class="s4">&quot;Management VM (Backup, Antivirus, vCenter)&quot; </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">):</span>
                    <span class="s1">additional_vm_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
                - **Management VM:**   
                  - Hosted on a **dedicated hardware pool** to ensure exclusive resources are allocated for management tasks, minimizing any impact on production workloads.   
                  - Alternatively, deployed as a **Distributed Management Node Allocation**, where management tasks are shared across production servers with **High Availability (HA)** configured.   
                    This ensures seamless continuity in the event of a server failure, as the remaining server(s) automatically take over the management operations. 
                    &quot;&quot;&quot;</span><span class="s2">)</span>

                <span class="s5"># Display notes only if they exist</span>
                <span class="s0">if </span><span class="s1">additional_vm_notes</span><span class="s2">:</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">additional_vm_notes</span><span class="s2">))</span>

            <span class="s5"># Display General Notes</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;General Notes:&quot;</span><span class="s2">)</span>
            <span class="s1">general_notes </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            - **Virtual Core (vCore) Definition:** 
                - Each **vCore** corresponds to a single thread within the physical processor. 
                - Physical processors typically support **two threads per core**, meaning the number of vCores is twice the number of physical cores. 
                - This 1:2 ratio between physical cores and vCores ensures optimal utilization of processor resources, enabling better performance and efficient workload distribution in virtualized environments. 
            &quot;&quot;&quot;</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">general_notes</span><span class="s2">)</span>

            <span class="s5"># Total Requirements for Additional VMs</span>

            <span class="s5"># Calculate VM Requirements (Grade 1 and Grade 3)</span>
            <span class="s1">results_grade1</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">first_year_storage_raid5_grade1</span><span class="s2">, </span><span class="s1">total_image_storage_raid5_grade1</span><span class="s2">, </span><span class="s1">total_vcpu_grade1</span><span class="s2">, </span><span class="s1">total_ram_grade1</span><span class="s2">, </span><span class="s1">total_storage_grade1 </span><span class="s2">= </span><span class="s1">calculate_vm_requirements</span><span class="s2">(</span>
                <span class="s1">num_studies</span><span class="s2">=</span><span class="s1">num_studies</span><span class="s2">,</span>
                <span class="s1">pacs_ccu</span><span class="s2">=</span><span class="s1">pacs_ccu</span><span class="s2">,</span>
                <span class="s1">ris_ccu</span><span class="s2">=</span><span class="s1">ris_ccu</span><span class="s2">,</span>
                <span class="s1">ref_phys_ccu</span><span class="s2">=</span><span class="s1">ref_phys_ccu</span><span class="s2">,</span>
                <span class="s1">project_grade</span><span class="s2">=</span><span class="s3">1</span><span class="s2">,</span>
                <span class="s1">broker_required</span><span class="s2">=</span><span class="s1">broker_required</span><span class="s2">,</span>
                <span class="s1">broker_level</span><span class="s2">=</span><span class="s1">broker_level</span><span class="s2">,</span>
                <span class="s1">num_machines</span><span class="s2">=</span><span class="s1">num_machines</span><span class="s2">,</span>
                <span class="s1">contract_duration</span><span class="s2">=</span><span class="s1">contract_duration</span><span class="s2">,</span>
                <span class="s1">study_size_mb</span><span class="s2">=</span><span class="s1">study_size_mb</span><span class="s2">,</span>
                <span class="s1">annual_growth_rate</span><span class="s2">=</span><span class="s1">annual_growth_rate</span><span class="s2">,</span>
                <span class="s1">breakdown_per_modality</span><span class="s2">=</span><span class="s1">breakdown_per_modality</span><span class="s2">,</span>
                <span class="s1">aidocker_included</span><span class="s2">=</span><span class="s1">aidocker_included</span><span class="s2">,</span>
                <span class="s1">ark_included</span><span class="s2">=</span><span class="s1">ark_included</span><span class="s2">,</span>
                <span class="s1">u9_ai_features</span><span class="s2">=[</span>
                    <span class="s4">&quot;Organ Segmentator&quot; </span><span class="s0">if </span><span class="s1">organ_segmentator </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 2D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_2d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 3D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_3d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Speech-to-text Container&quot; </span><span class="s0">if </span><span class="s1">speech_to_text_container </span><span class="s0">else None</span>
                <span class="s2">],</span>
                <span class="s1">ref_phys_external_access</span><span class="s2">=</span><span class="s1">ref_phys_external_access</span><span class="s2">,</span>
                <span class="s1">patient_portal_ccu</span><span class="s2">=</span><span class="s1">patient_portal_ccu</span><span class="s2">,</span>
                <span class="s1">patient_portal_external_access</span><span class="s2">=</span><span class="s1">patient_portal_external_access</span><span class="s2">,</span>
                <span class="s1">training_vm_included</span><span class="s2">=</span><span class="s1">training_vm_included</span><span class="s2">,</span>
                <span class="s1">high_availability</span><span class="s2">=</span><span class="s1">high_availability</span><span class="s2">,</span>
                <span class="s1">combine_pacs_ris</span><span class="s2">=</span><span class="s1">combine_pacs_ris</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">modality_cases</span>
            <span class="s2">)</span>

            <span class="s1">results_grade3</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">first_year_storage_raid5_grade3</span><span class="s2">, </span><span class="s1">total_image_storage_raid5_grade3</span><span class="s2">, </span><span class="s1">total_vcpu_grade3</span><span class="s2">, </span><span class="s1">total_ram_grade3</span><span class="s2">, </span><span class="s1">total_storage_grade3 </span><span class="s2">= </span><span class="s1">calculate_vm_requirements</span><span class="s2">(</span>
                <span class="s1">num_studies</span><span class="s2">=</span><span class="s1">num_studies</span><span class="s2">,</span>
                <span class="s1">pacs_ccu</span><span class="s2">=</span><span class="s1">pacs_ccu</span><span class="s2">,</span>
                <span class="s1">ris_ccu</span><span class="s2">=</span><span class="s1">ris_ccu</span><span class="s2">,</span>
                <span class="s1">ref_phys_ccu</span><span class="s2">=</span><span class="s1">ref_phys_ccu</span><span class="s2">,</span>
                <span class="s1">project_grade</span><span class="s2">=</span><span class="s3">3</span><span class="s2">,</span>
                <span class="s1">broker_required</span><span class="s2">=</span><span class="s1">broker_required</span><span class="s2">,</span>
                <span class="s1">broker_level</span><span class="s2">=</span><span class="s1">broker_level</span><span class="s2">,</span>
                <span class="s1">num_machines</span><span class="s2">=</span><span class="s1">num_machines</span><span class="s2">,</span>
                <span class="s1">contract_duration</span><span class="s2">=</span><span class="s1">contract_duration</span><span class="s2">,</span>
                <span class="s1">study_size_mb</span><span class="s2">=</span><span class="s1">study_size_mb</span><span class="s2">,</span>
                <span class="s1">annual_growth_rate</span><span class="s2">=</span><span class="s1">annual_growth_rate</span><span class="s2">,</span>
                <span class="s1">breakdown_per_modality</span><span class="s2">=</span><span class="s1">breakdown_per_modality</span><span class="s2">,</span>
                <span class="s1">aidocker_included</span><span class="s2">=</span><span class="s1">aidocker_included</span><span class="s2">,</span>
                <span class="s1">ark_included</span><span class="s2">=</span><span class="s1">ark_included</span><span class="s2">,</span>
                <span class="s1">u9_ai_features</span><span class="s2">=[</span>
                    <span class="s4">&quot;Organ Segmentator&quot; </span><span class="s0">if </span><span class="s1">organ_segmentator </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 2D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_2d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Lesion Segmentator 3D&quot; </span><span class="s0">if </span><span class="s1">lesion_segmentator_3d </span><span class="s0">else None</span><span class="s2">,</span>
                    <span class="s4">&quot;Speech-to-text Container&quot; </span><span class="s0">if </span><span class="s1">speech_to_text_container </span><span class="s0">else None</span>
                <span class="s2">],</span>
                <span class="s1">ref_phys_external_access</span><span class="s2">=</span><span class="s1">ref_phys_external_access</span><span class="s2">,</span>
                <span class="s1">patient_portal_ccu</span><span class="s2">=</span><span class="s1">patient_portal_ccu</span><span class="s2">,</span>
                <span class="s1">patient_portal_external_access</span><span class="s2">=</span><span class="s1">patient_portal_external_access</span><span class="s2">,</span>
                <span class="s1">training_vm_included</span><span class="s2">=</span><span class="s1">training_vm_included</span><span class="s2">,</span>
                <span class="s1">high_availability</span><span class="s2">=</span><span class="s1">high_availability</span><span class="s2">,</span>
                <span class="s1">combine_pacs_ris</span><span class="s2">=</span><span class="s1">combine_pacs_ris</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">modality_cases</span>
            <span class="s2">)</span>

            <span class="s5"># Define Storage Values for Display</span>
            <span class="s1">raid_1_storage_tb_g3 </span><span class="s2">= </span><span class="s1">results_grade3</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">] / </span><span class="s3">1024</span>
            <span class="s1">raid_5_storage_tb </span><span class="s2">= </span><span class="s1">total_image_storage_raid5_grade3 </span><span class="s2">/ </span><span class="s3">1024  </span><span class="s5"># Total HDD storage for full duration</span>
            <span class="s1">raid_1_storage </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">]  </span><span class="s5"># Tier 1 storage</span>
            <span class="s1">raid_1_storage_tb </span><span class="s2">= </span><span class="s1">raid_1_storage </span><span class="s2">/ </span><span class="s3">1024  </span><span class="s5"># Convert to TB</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Storage Requirements:&quot;</span><span class="s2">)</span>

            <span class="s5"># Initialize storage values</span>
            <span class="s1">years </span><span class="s2">= </span><span class="s1">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s1">contract_duration </span><span class="s2">+ </span><span class="s3">1</span><span class="s2">)</span>
            <span class="s1">tier_1_storage </span><span class="s2">= </span><span class="s1">raid_1_storage_tb  </span><span class="s5"># Constant for Tier 1</span>
            <span class="s1">tier_2_storage </span><span class="s2">= </span><span class="s0">None  </span><span class="s5"># Initialize Tier 2 storage as None</span>
            <span class="s1">tier_3_storage </span><span class="s2">= []  </span><span class="s5"># Initialize Tier 3 storage list for accumulation</span>

            <span class="s5"># Calculate the storage for the first year (initial storage)</span>
            <span class="s1">initial_year_storage </span><span class="s2">= (</span><span class="s1">num_studies </span><span class="s2">* </span><span class="s1">study_size_mb</span><span class="s2">) / </span><span class="s3">1024 </span><span class="s2">/ </span><span class="s3">1024  </span><span class="s5"># Convert to TB</span>

            <span class="s0">if </span><span class="s1">include_fast_tier_storage</span><span class="s2">:</span>
                <span class="s5"># Determine storage multiplier based on selection (6 months = 0.5, 1 year = 1.0)</span>
                <span class="s1">fast_storage_multiplier </span><span class="s2">= </span><span class="s3">0.5 </span><span class="s0">if </span><span class="s1">fast_tier_duration </span><span class="s2">== </span><span class="s4">&quot;6 Months&quot; </span><span class="s0">else </span><span class="s3">1.0</span>

                <span class="s1">tier_2_storage </span><span class="s2">= []  </span><span class="s5"># Initialize Tier 2 storage as an empty list</span>
                <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">years</span><span class="s2">:</span>
                    <span class="s1">year_storage </span><span class="s2">= </span><span class="s1">initial_year_storage </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s3">100</span><span class="s2">) ** (</span><span class="s1">year </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
                    <span class="s1">tier_2_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">year_storage </span><span class="s2">* </span><span class="s1">fast_storage_multiplier</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
                <span class="s1">tier_2_label </span><span class="s2">= </span><span class="s4">f&quot;Tier 2: Fast Image Storage (SSD RAID 5) (</span><span class="s0">{</span><span class="s1">fast_tier_duration</span><span class="s0">}</span><span class="s4">)&quot;</span>

                <span class="s5"># Calculate cumulative Tier 3 storage for each year</span>
                <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">years</span><span class="s2">:</span>
                    <span class="s1">current_year_storage </span><span class="s2">= </span><span class="s1">initial_year_storage </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s3">100</span><span class="s2">) ** (</span><span class="s1">year </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">year </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                        <span class="s1">tier_3_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">current_year_storage</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))  </span><span class="s5"># First year storage</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">cumulative_storage </span><span class="s2">= </span><span class="s1">tier_3_storage</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">current_year_storage</span>
                        <span class="s1">tier_3_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">cumulative_storage</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s5"># No intermediate Tier 2; promote Tier 3 to Tier 2</span>
                <span class="s1">tier_2_label </span><span class="s2">= </span><span class="s0">None  </span><span class="s5"># No Tier 2 storage</span>
                <span class="s5"># Initialize and calculate Tier 3 storage</span>
                <span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">years</span><span class="s2">:</span>
                    <span class="s1">current_year_storage </span><span class="s2">= </span><span class="s1">initial_year_storage </span><span class="s2">* (</span><span class="s3">1 </span><span class="s2">+ </span><span class="s1">annual_growth_rate </span><span class="s2">/ </span><span class="s3">100</span><span class="s2">) ** (</span><span class="s1">year </span><span class="s2">- </span><span class="s3">1</span><span class="s2">)</span>
                    <span class="s0">if </span><span class="s1">year </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:</span>
                        <span class="s1">tier_3_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">current_year_storage</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))  </span><span class="s5"># First year storage</span>
                    <span class="s0">else</span><span class="s2">:</span>
                        <span class="s1">cumulative_storage </span><span class="s2">= </span><span class="s1">tier_3_storage</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">] + </span><span class="s1">current_year_storage</span>
                        <span class="s1">tier_3_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">round</span><span class="s2">(</span><span class="s1">cumulative_storage</span><span class="s2">, </span><span class="s3">2</span><span class="s2">))</span>

            <span class="s5"># Use the final Tier 3 storage value in the comparison tables</span>
            <span class="s1">final_tier_3_storage </span><span class="s2">= </span><span class="s1">tier_3_storage</span><span class="s2">[-</span><span class="s3">1</span><span class="s2">]</span>

            <span class="s5"># Prepare storage data dictionary</span>
            <span class="s1">storage_data </span><span class="s2">= {</span>
                <span class="s4">&quot;Year&quot;</span><span class="s2">: [</span><span class="s4">f&quot;Year </span><span class="s0">{</span><span class="s1">year</span><span class="s0">}</span><span class="s4">&quot; </span><span class="s0">for </span><span class="s1">year </span><span class="s0">in </span><span class="s1">years</span><span class="s2">],</span>
                <span class="s4">&quot;Tier 1: OS &amp; DB (SSD RAID 1)&quot;</span><span class="s2">: [</span><span class="s1">round</span><span class="s2">(</span><span class="s1">tier_1_storage</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">years</span><span class="s2">),</span>
            <span class="s2">}</span>

            <span class="s0">if </span><span class="s1">tier_2_storage</span><span class="s2">:  </span><span class="s5"># Add Tier 2 only if it's present</span>
                <span class="s1">storage_data</span><span class="s2">[</span><span class="s1">tier_2_label</span><span class="s2">] = </span><span class="s1">tier_2_storage</span>

            <span class="s5"># Add Tier 3 to the storage table</span>
            <span class="s1">storage_data</span><span class="s2">[</span><span class="s4">&quot;Tier 3: Long-Term Storage (HDD RAID 5)&quot;</span><span class="s2">] = </span><span class="s1">tier_3_storage</span>

            <span class="s5"># Create and display the Storage Table</span>
            <span class="s1">storage_table </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">storage_data</span><span class="s2">).</span><span class="s1">reset_index</span><span class="s2">(</span><span class="s1">drop</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">table</span><span class="s2">(</span><span class="s1">storage_table</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">2</span><span class="s2">))</span>

            <span class="s5"># Resource Comparison Table</span>
            <span class="s5"># Minimum vs Recommended Resources for Grade 1</span>
            <span class="s0">if </span><span class="s1">project_grade </span><span class="s2">== </span><span class="s3">1</span><span class="s2">:  </span><span class="s5"># Minimum vs Recommended Resources for Grade 1</span>
                <span class="s1">comparison_data </span><span class="s2">= {</span>
                    <span class="s4">&quot;Specification&quot;</span><span class="s2">: [</span><span class="s4">&quot;Total vCores&quot;</span><span class="s2">, </span><span class="s4">&quot;Total RAM (GB)&quot;</span><span class="s2">, </span><span class="s4">&quot;RAID 1 (SSD) (TB)&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;RAID 5 (HDD) Full Duration (TB)&quot;</span><span class="s2">],</span>
                    <span class="s4">&quot;Minimum Specs&quot;</span><span class="s2">: [</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_vcpu_grade1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_ram_grade1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">raid_1_storage_tb</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">final_tier_3_storage</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),  </span><span class="s5"># Use final Tier 3 storage</span>
                    <span class="s2">],</span>
                    <span class="s4">&quot;Recommended Specs&quot;</span><span class="s2">: [</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_vcpu_grade3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_ram_grade3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">raid_1_storage_tb_g3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">final_tier_3_storage</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),  </span><span class="s5"># Use final Tier 3 storage</span>
                    <span class="s2">],</span>
                <span class="s2">}</span>
                <span class="s1">df_comparison </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">comparison_data</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Minimum vs. Recommended Resources:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">table</span><span class="s2">(</span>
                    <span class="s1">df_comparison</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">set_table_styles</span><span class="s2">(</span>
                        <span class="s2">[</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;thead th&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;font-size&quot;</span><span class="s2">, </span><span class="s4">&quot;16px&quot;</span><span class="s2">), (</span><span class="s4">&quot;font-weight&quot;</span><span class="s2">, </span><span class="s4">&quot;bold&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody td&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;font-size&quot;</span><span class="s2">, </span><span class="s4">&quot;14px&quot;</span><span class="s2">), (</span><span class="s4">&quot;text-align&quot;</span><span class="s2">, </span><span class="s4">&quot;center&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody tr:nth-child(even)&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;background-color&quot;</span><span class="s2">, </span><span class="s4">&quot;#f9f9f9&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody tr:hover&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;background-color&quot;</span><span class="s2">, </span><span class="s4">&quot;#f1f1f1&quot;</span><span class="s2">)]},</span>
                        <span class="s2">]</span>
                    <span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
                <span class="s2">)</span>

            <span class="s5"># Recommended Resources Table for Grade 2 or 3</span>
            <span class="s0">elif </span><span class="s1">project_grade </span><span class="s0">in </span><span class="s2">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">]:  </span><span class="s5"># Only Recommended Resources for Grade 2 or 3</span>
                <span class="s1">recommended_data </span><span class="s2">= {</span>
                    <span class="s4">&quot;Specification&quot;</span><span class="s2">: [</span><span class="s4">&quot;Total vCores&quot;</span><span class="s2">, </span><span class="s4">&quot;Total RAM (GB)&quot;</span><span class="s2">, </span><span class="s4">&quot;RAID 1 (SSD) (TB)&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;RAID 5 (HDD) Full Duration (TB)&quot;</span><span class="s2">],</span>
                    <span class="s4">&quot;Recommended Specs&quot;</span><span class="s2">: [</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_vcpu_grade3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_ram_grade3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">raid_1_storage_tb_g3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">final_tier_3_storage</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),  </span><span class="s5"># Use final Tier 3 storage</span>
                    <span class="s2">],</span>
                <span class="s2">}</span>
                <span class="s1">df_comparison </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">recommended_data</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Recommended Resources:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">table</span><span class="s2">(</span>
                    <span class="s1">df_comparison</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">set_table_styles</span><span class="s2">(</span>
                        <span class="s2">[</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;thead th&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;font-size&quot;</span><span class="s2">, </span><span class="s4">&quot;16px&quot;</span><span class="s2">), (</span><span class="s4">&quot;font-weight&quot;</span><span class="s2">, </span><span class="s4">&quot;bold&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody td&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;font-size&quot;</span><span class="s2">, </span><span class="s4">&quot;14px&quot;</span><span class="s2">), (</span><span class="s4">&quot;text-align&quot;</span><span class="s2">, </span><span class="s4">&quot;center&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody tr:nth-child(even)&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;background-color&quot;</span><span class="s2">, </span><span class="s4">&quot;#f9f9f9&quot;</span><span class="s2">)]},</span>
                            <span class="s2">{</span><span class="s4">&quot;selector&quot;</span><span class="s2">: </span><span class="s4">&quot;tbody tr:hover&quot;</span><span class="s2">, </span><span class="s4">&quot;props&quot;</span><span class="s2">: [(</span><span class="s4">&quot;background-color&quot;</span><span class="s2">, </span><span class="s4">&quot;#f1f1f1&quot;</span><span class="s2">)]},</span>
                        <span class="s2">]</span>
                    <span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">1</span><span class="s2">)</span>
                <span class="s2">)</span>

            <span class="s5"># Calculate Additional VM Requirements</span>
            <span class="s0">if </span><span class="s1">additional_vms</span><span class="s2">:</span>
                <span class="s5"># Calculate totals for additional VMs</span>
                <span class="s1">total_additional_vcpu </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;vCores&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>
                <span class="s1">total_additional_ram </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>
                <span class="s1">total_additional_ssd </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">) / </span><span class="s3">1024  </span><span class="s5"># Convert to TB</span>
                <span class="s1">total_additional_hdd </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)  </span><span class="s5"># HDD in TB</span>

                <span class="s5"># Define the additional requirements table</span>
                <span class="s1">additional_requirements_data </span><span class="s2">= {</span>
                    <span class="s4">&quot;Specification&quot;</span><span class="s2">: [</span><span class="s4">&quot;Total vCores&quot;</span><span class="s2">, </span><span class="s4">&quot;Total RAM (GB)&quot;</span><span class="s2">, </span><span class="s4">&quot;Total SSD Storage (TB)&quot;</span><span class="s2">,</span>
                                      <span class="s4">&quot;Total HDD Storage (TB)&quot;</span><span class="s2">],</span>
                    <span class="s4">&quot;Requirements&quot;</span><span class="s2">: [</span>
                        <span class="s1">total_additional_vcpu</span><span class="s2">,</span>
                        <span class="s1">total_additional_ram</span><span class="s2">,</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_additional_ssd</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),  </span><span class="s5"># Round to 1 decimal point for consistency</span>
                        <span class="s1">round</span><span class="s2">(</span><span class="s1">total_additional_hdd</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                    <span class="s2">],</span>
                <span class="s2">}</span>
                <span class="s1">additional_requirements_table </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">additional_requirements_data</span><span class="s2">)</span>

                <span class="s5"># Display in Streamlit (if applicable)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Requirements for Additional VMs:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">table</span><span class="s2">(</span><span class="s1">additional_requirements_table</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">1</span><span class="s2">))</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">additional_requirements_table </span><span class="s2">= </span><span class="s0">None  </span><span class="s5"># Ensure it is set to None if no additional VMs</span>

            <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Starting Physical System Allocation&quot;</span><span class="s2">)</span>
            <span class="s1">total_vcpu </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;Total&quot;</span><span class="s2">, </span><span class="s4">&quot;vCores&quot;</span><span class="s2">]</span>
            <span class="s1">total_ram </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;Total&quot;</span><span class="s2">, </span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">]</span>

            <span class="s5"># Include additional VMs in the physical hardware calculations</span>
            <span class="s1">total_vcpu </span><span class="s2">+= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;vCores&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>
            <span class="s1">total_ram </span><span class="s2">+= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>

            <span class="s1">max_threads_per_server </span><span class="s2">= </span><span class="s3">128</span>
            <span class="s1">max_ram_per_server </span><span class="s2">= </span><span class="s3">512</span>

            <span class="s5"># Section: Physical System Design</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Physical System Design&quot;</span><span class="s2">)</span>

            <span class="s5"># Server Design for Production Servers</span>
            <span class="s1">servers </span><span class="s2">= []</span>
            <span class="s0">if </span><span class="s1">high_availability</span><span class="s2">:</span>
                <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Calculating high availability resources&quot;</span><span class="s2">)</span>
                <span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;Length of servers:&quot;</span><span class="s2">, </span><span class="s1">len</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">))</span>

                <span class="s5"># Check the number of servers in normal design</span>
                <span class="s0">if </span><span class="s1">total_vcpu </span><span class="s2">&gt; </span><span class="s1">max_threads_per_server </span><span class="s0">or </span><span class="s1">total_ram </span><span class="s2">&gt; </span><span class="s1">max_ram_per_server</span><span class="s2">:</span>
                    <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Total workload exceeds max server specs. Using dynamic HA allocation logic.&quot;</span><span class="s2">)</span>

                    <span class="s5"># Scale total resources for Active-Active HA</span>
                    <span class="s1">total_vcpu_ha </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">total_vcpu </span><span class="s2">* </span><span class="s3">1.5</span><span class="s2">)</span>
                    <span class="s1">total_ram_ha </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">total_ram </span><span class="s2">* </span><span class="s3">1.5</span><span class="s2">)</span>

                    <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">total_vcpu_ha</span><span class="s2">, </span><span class="s1">total_ram_ha</span>
                    <span class="s0">while </span><span class="s1">remaining_threads </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">remaining_ram </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s0">if </span><span class="s1">remaining_ram </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                            <span class="s1">logging</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;No remaining RAM to allocate. Exiting loop.&quot;</span><span class="s2">)</span>
                            <span class="s0">break</span>
                        <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">add_server</span><span class="s2">(</span>
                            <span class="s1">servers</span><span class="s2">,</span>
                            <span class="s1">remaining_threads</span><span class="s2">,</span>
                            <span class="s1">remaining_ram</span><span class="s2">,</span>
                            <span class="s1">max_threads_per_server</span><span class="s2">,</span>
                            <span class="s1">max_ram_per_server</span>
                        <span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Total workload is within max server specs. Enforcing two servers for HA redundancy.&quot;</span><span class="s2">)</span>

                    <span class="s5"># Allocate two servers with 75% of total resources</span>
                    <span class="s1">threads_per_server </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">total_vcpu </span><span class="s2">* </span><span class="s3">0.75</span><span class="s2">)</span>
                    <span class="s1">ram_per_server </span><span class="s2">= </span><span class="s1">int</span><span class="s2">(</span><span class="s1">total_ram </span><span class="s2">* </span><span class="s3">0.75</span><span class="s2">)</span>

                    <span class="s5"># Ensure threads are divisible by 2</span>
                    <span class="s0">if </span><span class="s1">threads_per_server </span><span class="s2">% </span><span class="s3">2 </span><span class="s2">!= </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">threads_per_server </span><span class="s2">-= </span><span class="s3">1</span>

                    <span class="s5"># Clear any existing servers</span>
                    <span class="s1">servers</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>

                    <span class="s5"># Add two servers with adjusted resources</span>
                    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">2</span><span class="s2">):</span>
                        <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">add_server</span><span class="s2">(</span>
                            <span class="s1">servers</span><span class="s2">,</span>
                            <span class="s1">threads_per_server</span><span class="s2">,</span>
                            <span class="s1">ram_per_server</span><span class="s2">,</span>
                            <span class="s1">max_threads_per_server</span><span class="s2">,</span>
                            <span class="s1">max_ram_per_server</span>
                        <span class="s2">)</span>

                    <span class="s5"># Fallback to ensure exactly two servers exist</span>
                    <span class="s0">while </span><span class="s1">len</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">) &lt; </span><span class="s3">2</span><span class="s2">:</span>
                        <span class="s1">servers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                            <span class="s1">servers</span><span class="s2">[</span><span class="s3">0</span><span class="s2">].</span><span class="s1">copy</span><span class="s2">())  </span><span class="s5"># Duplicate the first server if fewer than 2 servers are added</span>

                <span class="s5"># Format and display servers</span>
                <span class="s1">server_specs </span><span class="s2">= </span><span class="s1">format_server_specs</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">, </span><span class="s1">base_name</span><span class="s2">=</span><span class="s4">&quot;Production Server&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### High Availability Server Design&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">server_specs</span><span class="s2">)</span>

                <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;High availability server allocation complete&quot;</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Calculating standard server resources&quot;</span><span class="s2">)</span>
                <span class="s1">num_servers </span><span class="s2">= (</span><span class="s1">total_vcpu </span><span class="s2">+ </span><span class="s1">max_threads_per_server </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) // </span><span class="s1">max_threads_per_server</span>
                <span class="s1">avg_ram_per_server </span><span class="s2">= (</span><span class="s1">total_ram </span><span class="s2">+ </span><span class="s1">num_servers </span><span class="s2">- </span><span class="s3">1</span><span class="s2">) // </span><span class="s1">num_servers</span>

                <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">total_vcpu</span><span class="s2">, </span><span class="s1">total_ram</span>
                <span class="s0">while </span><span class="s1">remaining_threads </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">remaining_ram </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">remaining_ram </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">logging</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">f&quot;No remaining RAM to allocate. Exiting loop.&quot;</span><span class="s2">)</span>
                        <span class="s0">break</span>
                    <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">add_server</span><span class="s2">(</span>
                        <span class="s1">servers</span><span class="s2">, </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span><span class="s2">, </span><span class="s1">max_threads_per_server</span><span class="s2">, </span><span class="s1">avg_ram_per_server</span>
                    <span class="s2">)</span>

                <span class="s1">server_specs </span><span class="s2">= </span><span class="s1">format_server_specs</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">, </span><span class="s1">base_name</span><span class="s2">=</span><span class="s4">&quot;Production Server&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Standard Server Design&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">server_specs</span><span class="s2">)</span>

                <span class="s1">logging</span><span class="s2">.</span><span class="s1">info</span><span class="s2">(</span><span class="s4">&quot;Standard server allocation complete&quot;</span><span class="s2">)</span>
            <span class="s1">additional_servers </span><span class="s2">= []</span>
            <span class="s5"># Additional VMs on Separate Hardware Pool</span>
            <span class="s0">if </span><span class="s1">additional_vms</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Additional VM Hardware Design&quot;</span><span class="s2">)</span>

                <span class="s1">additional_total_vcpu </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;vCores&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>
                <span class="s1">additional_total_ram </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;RAM (GB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)</span>
                <span class="s1">additional_total_ssd </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span>
                    <span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">) / </span><span class="s3">1024  </span><span class="s5"># Convert SSD to TB</span>
                <span class="s1">additional_total_hdd </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">vm</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s4">&quot;RAID 5 Storage (TB)&quot;</span><span class="s2">, </span><span class="s3">0</span><span class="s2">) </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">)  </span><span class="s5"># HDD in TB</span>
                <span class="s5"># Determine base name for additional servers</span>
                <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">additional_vms</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">:</span>
                    <span class="s1">additional_vm_type </span><span class="s2">= </span><span class="s1">additional_vms</span><span class="s2">[</span><span class="s3">0</span><span class="s2">][</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">]</span>
                    <span class="s0">if </span><span class="s4">&quot;Test&quot; </span><span class="s0">in </span><span class="s1">additional_vm_type</span><span class="s2">:</span>
                        <span class="s1">base_name </span><span class="s2">= </span><span class="s4">&quot;Test Server&quot;</span>
                    <span class="s0">elif </span><span class="s4">&quot;Management&quot; </span><span class="s0">in </span><span class="s1">additional_vm_type</span><span class="s2">:</span>
                        <span class="s1">base_name </span><span class="s2">= </span><span class="s4">&quot;Management Server&quot;</span>
                <span class="s0">elif </span><span class="s1">any</span><span class="s2">(</span><span class="s4">&quot;Management&quot; </span><span class="s0">in </span><span class="s1">vm</span><span class="s2">[</span><span class="s4">&quot;VM Type&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">vm </span><span class="s0">in </span><span class="s1">additional_vms</span><span class="s2">):</span>
                    <span class="s1">base_name </span><span class="s2">= </span><span class="s4">&quot;Test and Management Server&quot;</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">base_name </span><span class="s2">= </span><span class="s4">&quot;Additional Server&quot;</span>

                <span class="s5"># Calculate physical servers for additional VMs</span>
                <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">additional_total_vcpu</span><span class="s2">, </span><span class="s1">additional_total_ram</span>
                <span class="s0">while </span><span class="s1">remaining_threads </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">remaining_ram </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">remaining_ram </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">logging</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">f&quot;No remaining RAM to allocate for additional VMs. Exiting loop.&quot;</span><span class="s2">)</span>
                        <span class="s0">break</span>
                    <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">add_server</span><span class="s2">(</span>
                        <span class="s1">additional_servers</span><span class="s2">, </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span><span class="s2">, </span><span class="s1">max_threads_per_server</span><span class="s2">, </span><span class="s1">max_ram_per_server</span>
                    <span class="s2">)</span>

                <span class="s1">additional_server_specs </span><span class="s2">= </span><span class="s1">format_server_specs</span><span class="s2">(</span><span class="s1">additional_servers</span><span class="s2">, </span><span class="s1">base_name</span><span class="s2">=</span><span class="s1">base_name</span><span class="s2">)</span>

                <span class="s5"># Display Additional VM Hardware Design</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">additional_server_specs</span><span class="s2">)</span>

                <span class="s5"># Display storage details under hardware design</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&quot;&quot;</span>
                <span class="s4">**Storage Configuration for Additional Pool:**</span>
                <span class="s4">- **SSD Storage:** </span><span class="s0">{</span><span class="s1">round</span><span class="s2">(</span><span class="s1">additional_total_ssd </span><span class="s2">* </span><span class="s3">1024</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span><span class="s0">} </span><span class="s4">GB</span>
                <span class="s4">- **HDD Storage (RAID 5):** </span><span class="s0">{</span><span class="s1">round</span><span class="s2">(</span><span class="s1">additional_total_hdd</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span><span class="s0">} </span><span class="s4">TB</span>
                <span class="s4">&quot;&quot;&quot;</span><span class="s2">)</span>

            <span class="s5"># Storage Details</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Storage Design&quot;</span><span class="s2">)</span>

            <span class="s5"># Tier 1: OS &amp; DB (SSD RAID 1)</span>
            <span class="s1">raid_1_storage </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">]  </span><span class="s5"># Tier 1 storage</span>
            <span class="s1">raid_1_storage_tb </span><span class="s2">= </span><span class="s1">raid_1_storage </span><span class="s2">/ </span><span class="s3">1024  </span><span class="s5"># Convert to TB</span>

            <span class="s5"># Tier 2: Fast Image Storage (SSD RAID 5) or Long-Term Storage</span>
            <span class="s0">if </span><span class="s1">include_fast_tier_storage</span><span class="s2">:</span>
                <span class="s1">intermediate_tier_multiplier </span><span class="s2">= </span><span class="s3">0.5 </span><span class="s0">if </span><span class="s1">fast_tier_duration </span><span class="s2">== </span><span class="s4">&quot;6 Months&quot; </span><span class="s0">else </span><span class="s3">1.0</span>
                <span class="s1">intermediate_tier_storage_tb </span><span class="s2">= </span><span class="s1">math</span><span class="s2">.</span><span class="s1">ceil</span><span class="s2">(</span>
                    <span class="s1">first_year_storage_raid5 </span><span class="s2">* </span><span class="s1">intermediate_tier_multiplier </span><span class="s2">/ </span><span class="s3">1024</span>
                <span class="s2">)  </span><span class="s5"># Convert to TB</span>
                <span class="s1">tier_2_disks</span><span class="s2">, </span><span class="s1">tier_2_disk_size </span><span class="s2">= </span><span class="s1">calculate_raid5_disks</span><span class="s2">(</span><span class="s1">intermediate_tier_storage_tb</span><span class="s2">)</span>
                <span class="s1">tier_2_label </span><span class="s2">= </span><span class="s4">&quot;Tier 2: Fast Image Storage (SSD RAID 5)&quot;</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">tier_2_disks</span><span class="s2">, </span><span class="s1">tier_2_disk_size </span><span class="s2">= </span><span class="s1">calculate_raid5_disks</span><span class="s2">(</span><span class="s1">final_tier_3_storage</span><span class="s2">)</span>
                <span class="s1">tier_2_label </span><span class="s2">= </span><span class="s4">&quot;Tier 2: Long-Term Storage (HDD RAID 5)&quot;</span>
                <span class="s1">tier_3_disks</span><span class="s2">, </span><span class="s1">tier_3_disk_size </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0  </span><span class="s5"># No separate Tier 3</span>

            <span class="s5"># Tier 3: Long-Term Storage (HDD RAID 5) if Tier 2 is SSD RAID 5</span>
            <span class="s0">if </span><span class="s1">include_fast_tier_storage</span><span class="s2">:</span>
                <span class="s1">tier_3_disks</span><span class="s2">, </span><span class="s1">tier_3_disk_size </span><span class="s2">= </span><span class="s1">calculate_raid5_disks</span><span class="s2">(</span><span class="s1">final_tier_3_storage</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">tier_3_disks</span><span class="s2">, </span><span class="s1">tier_3_disk_size </span><span class="s2">= </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span>

            <span class="s5"># Determine storage type</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">) == </span><span class="s3">1 </span><span class="s0">and not </span><span class="s1">high_availability</span><span class="s2">:</span>
                <span class="s1">storage_type </span><span class="s2">= </span><span class="s4">&quot;Built-in Storage&quot;</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">storage_type </span><span class="s2">= </span><span class="s4">&quot;Shared DAS/SAN Storage&quot;</span>

            <span class="s5"># Generate Storage Details</span>
            <span class="s1">storage_details </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
            <span class="s4">#### Storage Details (</span><span class="s0">{</span><span class="s1">storage_type</span><span class="s0">}</span><span class="s4">)</span>

            <span class="s4">**Tier 1: OS &amp; DB (SSD RAID 1):**</span>
            <span class="s4">- SSD Drives: 2x </span><span class="s0">{</span><span class="s1">raid_1_storage_tb</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB</span>
            <span class="s4">&quot;&quot;&quot;</span>

            <span class="s5"># Add Tier 2 Storage</span>
            <span class="s0">if </span><span class="s1">tier_2_disks </span><span class="s0">and </span><span class="s1">tier_2_disk_size</span><span class="s2">:</span>
                <span class="s1">storage_details </span><span class="s2">+= </span><span class="s4">f&quot;&quot;&quot;</span>
            <span class="s4">**</span><span class="s0">{</span><span class="s1">tier_2_label</span><span class="s0">}</span><span class="s4">:**</span>
            <span class="s4">- Drives: </span><span class="s0">{</span><span class="s1">tier_2_disks</span><span class="s0">}</span><span class="s4">x </span><span class="s0">{</span><span class="s1">tier_2_disk_size</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB</span>
            <span class="s4">&quot;&quot;&quot;</span>

            <span class="s5"># Add Tier 3 Storage (if applicable)</span>
            <span class="s0">if </span><span class="s1">tier_3_disks </span><span class="s0">and </span><span class="s1">tier_3_disk_size</span><span class="s2">:</span>
                <span class="s1">storage_details </span><span class="s2">+= </span><span class="s4">f&quot;&quot;&quot;</span>
            <span class="s4">**Tier 3: Long-Term Storage (HDD RAID 5):**</span>
            <span class="s4">- HDD Drives: </span><span class="s0">{</span><span class="s1">tier_3_disks</span><span class="s0">}</span><span class="s4">x </span><span class="s0">{</span><span class="s1">tier_3_disk_size</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB</span>
            <span class="s4">&quot;&quot;&quot;</span>

            <span class="s5"># Handle cases where no details are available</span>
            <span class="s0">if not </span><span class="s1">tier_2_disks </span><span class="s0">and not </span><span class="s1">tier_3_disks</span><span class="s2">:</span>
                <span class="s1">storage_details </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
            **Details not available for some tiers.** 
            &quot;&quot;&quot;</span>

            <span class="s5"># Display Storage Details</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">storage_details</span><span class="s2">)</span>

            <span class="s5"># Backup Storage (NAS)</span>
            <span class="s0">if </span><span class="s1">use_nas_backup</span><span class="s2">:</span>
                <span class="s5"># Calculate NAS storage based on redundancy factor and backup years</span>
                <span class="s1">nas_storage_gb </span><span class="s2">= </span><span class="s1">round</span><span class="s2">(</span>
                    <span class="s2">(</span><span class="s1">total_image_storage_raid5 </span><span class="s2">* </span><span class="s1">nas_redundancy_factor </span><span class="s2">* </span><span class="s1">nas_backup_years</span><span class="s2">) / </span><span class="s1">contract_duration</span><span class="s2">)</span>
                <span class="s1">nas_storage_tb </span><span class="s2">= </span><span class="s1">nas_storage_gb </span><span class="s2">/ </span><span class="s3">1024  </span><span class="s5"># Convert to TB</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;#### Backup Storage (NAS):&quot;</span><span class="s2">)</span>
                <span class="s5"># Display the calculated NAS storage</span>

                <span class="s1">nas_backup_string </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                <span class="s4">- **NAS Storage:** </span><span class="s0">{</span><span class="s1">nas_storage_tb</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB</span>
                <span class="s4">- **Redundancy Factor Applied:** </span><span class="s0">{</span><span class="s1">nas_redundancy_factor</span><span class="s0">:</span><span class="s4">.1f</span><span class="s0">}</span>
                <span class="s4">- **Backup Duration:** </span><span class="s0">{</span><span class="s1">nas_backup_years</span><span class="s0">} </span><span class="s4">years</span>
                <span class="s4">- **Network Ports:** Minimum 2 (1 Gigabit; 10 Gigabit recommended)</span>
                <span class="s4">- **Memory:** 8 GB (16 GB recommended)</span>
                <span class="s4">- **Power Supply:** Dual (for redundancy)</span>
                <span class="s4">- **RAID Configuration:** RAID 5 + hotspare for data protection</span>
                <span class="s4">&quot;&quot;&quot;</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">nas_backup_string</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">nas_backup_string </span><span class="s2">= </span><span class="s0">None</span>

            <span class="s1">non_total_display_results </span><span class="s2">= </span><span class="s1">display_results</span><span class="s2">[</span><span class="s1">display_results</span><span class="s2">.</span><span class="s1">index </span><span class="s2">!= </span><span class="s4">&quot;Total&quot;</span><span class="s2">]</span>
            <span class="s1">windows_count </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">non_total_display_results</span><span class="s2">) - </span><span class="s1">len</span><span class="s2">(</span>
                <span class="s1">non_total_display_results</span><span class="s2">[</span><span class="s1">non_total_display_results</span><span class="s2">[</span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] == </span><span class="s4">&quot;Ubuntu 20.4&quot;</span><span class="s2">])</span>
            <span class="s5"># Initialize GPU specs</span>
            <span class="s1">gpu_specs </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>

            <span class="s0">if </span><span class="s1">aidocker_included </span><span class="s0">or </span><span class="s1">ark_included</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;GPU Requirements:&quot;</span><span class="s2">)</span>
                <span class="s1">total_gpu_memory </span><span class="s2">= </span><span class="s3">0</span>
                <span class="s1">gpu_modules </span><span class="s2">= []</span>

                <span class="s5"># Check and add U9.Ai modules</span>
                <span class="s0">if </span><span class="s1">organ_segmentator</span><span class="s2">:</span>
                    <span class="s1">gpu_modules</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Organ Segmentator&quot;</span><span class="s2">)</span>
                    <span class="s1">total_gpu_memory </span><span class="s2">+= </span><span class="s3">16</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_2d</span><span class="s2">:</span>
                    <span class="s1">gpu_modules</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 2D&quot;</span><span class="s2">)</span>
                    <span class="s1">total_gpu_memory </span><span class="s2">+= </span><span class="s3">4</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_3d</span><span class="s2">:</span>
                    <span class="s1">gpu_modules</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 3D&quot;</span><span class="s2">)</span>
                    <span class="s1">total_gpu_memory </span><span class="s2">+= </span><span class="s3">12</span>
                <span class="s0">if </span><span class="s1">speech_to_text_container</span><span class="s2">:</span>
                    <span class="s1">gpu_modules</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Speech-to-Text Container&quot;</span><span class="s2">)</span>
                    <span class="s1">total_gpu_memory </span><span class="s2">+= </span><span class="s3">4</span>

                <span class="s5"># Generate GPU specs for U9.Ai</span>
                <span class="s0">if </span><span class="s1">aidocker_included</span><span class="s2">:</span>
                    <span class="s1">gpu_specs </span><span class="s2">= </span><span class="s4">f&quot;&quot;&quot;</span>
                    <span class="s4">- **Total GPU Memory Required**: </span><span class="s0">{</span><span class="s1">total_gpu_memory</span><span class="s0">} </span><span class="s4">GB</span>
                    <span class="s4">- **NVIDIA GPUs**: Recommended</span>
                    <span class="s4">- **Modules**: </span><span class="s0">{</span><span class="s4">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">gpu_modules</span><span class="s2">)</span><span class="s0">}</span>
                    <span class="s4">- **Driver Requirements**: NVIDIA Driver version 450.80.02 or higher, supporting CUDA version 11.4 or higher.</span>
                    <span class="s4">&quot;&quot;&quot;</span>

                <span class="s5"># Handle ARKAI separately</span>
                <span class="s0">if </span><span class="s1">ark_included</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">aidocker_included</span><span class="s2">:</span>
                        <span class="s1">gpu_specs </span><span class="s2">+= </span><span class="s4">&quot;</span><span class="s0">\n\n</span><span class="s4">&quot;</span>
                    <span class="s1">gpu_specs </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
                    - **ARKAI Requirements**: 
                      - Dedicated GPU required for ARKAI workloads. 
                      - Recommended GPU Memory for ARKAI: 16 GB. 
                      - **Driver Requirements**: NVIDIA Driver version 450.80.02 or higher, supporting CUDA version 11.4 or higher. 
                    &quot;&quot;&quot;</span>


                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">gpu_specs</span><span class="s2">)</span>
            <span class="s5"># Filter Ubuntu Licenses</span>
            <span class="s1">ubuntu_vms_count </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span>
                <span class="s1">non_total_display_results</span><span class="s2">[</span><span class="s1">non_total_display_results</span><span class="s2">[</span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] == </span><span class="s4">&quot;Ubuntu 20.4&quot;</span><span class="s2">])</span>

            <span class="s5"># Update the Third Party Licenses DataFrame</span>
            <span class="s1">third_party_licenses </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                <span class="s4">&quot;Item Description&quot;</span><span class="s2">: [</span>
                    <span class="s1">sql_license</span><span class="s2">,</span>
                    <span class="s4">&quot;MS Windows Server Standard 2019 or higher&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Antivirus Server License&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Virtualization Platform License(VMware or HyperV) (Supports High Availability)&quot; </span><span class="s0">if </span><span class="s1">high_availability </span><span class="s0">else </span><span class="s4">&quot;Virtualization Platform License&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Backup Software (Compatible with VMs)&quot;</span><span class="s2">,</span>
                    <span class="s4">&quot;Ubuntu 20.4 Server License&quot; </span><span class="s0">if </span><span class="s1">ubuntu_vms_count </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">else None</span>
                <span class="s2">],</span>
                <span class="s4">&quot;Qty&quot;</span><span class="s2">: [</span>
                    <span class="s1">int</span><span class="s2">(</span><span class="s3">2 </span><span class="s0">if </span><span class="s1">training_vm_included </span><span class="s0">else </span><span class="s3">1</span><span class="s2">),  </span><span class="s5"># SQL licenses</span>
                    <span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">non_total_display_results</span><span class="s2">)-</span><span class="s1">ubuntu_vms_count</span><span class="s2">),  </span><span class="s5"># One Windows license per VM</span>
                    <span class="s1">int</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">non_total_display_results</span><span class="s2">)-</span><span class="s1">ubuntu_vms_count</span><span class="s2">),  </span><span class="s5"># One Antivirus license per VM</span>
                    <span class="s3">1</span><span class="s2">,  </span><span class="s5"># Virtualization license</span>
                    <span class="s3">1</span><span class="s2">,  </span><span class="s5"># Backup software license</span>
                    <span class="s1">int</span><span class="s2">(</span><span class="s1">ubuntu_vms_count</span><span class="s2">) </span><span class="s0">if </span><span class="s1">ubuntu_vms_count </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">else None  </span><span class="s5"># Ubuntu licenses</span>
                <span class="s2">]</span>
            <span class="s2">})</span>

            <span class="s5"># Remove rows with None values</span>
            <span class="s1">third_party_licenses </span><span class="s2">= </span><span class="s1">third_party_licenses</span><span class="s2">.</span><span class="s1">dropna</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">=[</span><span class="s4">&quot;Item Description&quot;</span><span class="s2">, </span><span class="s4">&quot;Qty&quot;</span><span class="s2">])</span>
            <span class="s1">third_party_licenses</span><span class="s2">[</span><span class="s4">&quot;Qty&quot;</span><span class="s2">] = </span><span class="s1">third_party_licenses</span><span class="s2">[</span><span class="s4">&quot;Qty&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

            <span class="s5"># Display the Third Party Licenses Table</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Third Party Licenses&quot;</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">third_party_licenses</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">set_properties</span><span class="s2">(</span><span class="s1">subset</span><span class="s2">=[</span><span class="s4">&quot;Item Description&quot;</span><span class="s2">], **{</span><span class="s4">'width'</span><span class="s2">: </span><span class="s4">'300px'</span><span class="s2">}))</span>

            <span class="s5"># Add Notes Section</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Licensing Notes&quot;</span><span class="s2">)</span>
            <span class="s1">notes </span><span class="s2">= []</span>

            <span class="s5"># Windows Licensing Note</span>
            <span class="s1">notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s4">&quot;- **Windows Server Licensing:** Each VM requires an active Windows Server license. For environments with a Data Center license, these licenses may be unlimited. Verify the licensing model in use.&quot;</span><span class="s2">)</span>

            <span class="s5"># Virtualization Licensing Note (HA-Specific)</span>
            <span class="s0">if </span><span class="s1">high_availability</span><span class="s2">:</span>
                <span class="s1">notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s4">&quot;- **Virtualization Platform Licensing:** Ensure the selected platform (e.g., VMware or Hyper-V) supports High Availability features (e.g., vMotion, Live Migration).&quot;</span><span class="s2">)</span>

            <span class="s5"># Ubuntu Licensing Note (Only if Ubuntu VMs Exist)</span>
            <span class="s0">if </span><span class="s1">ubuntu_vms_count </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s4">&quot;- **Ubuntu Licensing:** Ensure sufficient Ubuntu Server licenses are available for VMs running on Linux.&quot;</span><span class="s2">)</span>

            <span class="s5"># Antivirus Licensing Note</span>
            <span class="s1">notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;- **Antivirus Licensing:** One license per VM is required unless otherwise specified.&quot;</span><span class="s2">)</span>

            <span class="s5"># Backup Software Note</span>
            <span class="s1">notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;- **Backup Software:** Ensure compatibility with selected VMs and storage solutions.&quot;</span><span class="s2">)</span>

            <span class="s5"># Render Notes Dynamically</span>
            <span class="s0">for </span><span class="s1">note </span><span class="s0">in </span><span class="s1">notes</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">note</span><span class="s2">)</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Sizing Notes:&quot;</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
            - Provided VM sizing of the Virtual servers will be scaled up horizontally or vertically based on the expected volume of data and number of CCUs. 
            - SSD Datastore recommended for all OS Virtual disks of all VMs. 
            - SSD recommended for the data drive of the Database Server. 
            - It's recommended to have SSD storage for the short Term Storage (STS) that keep last 6 months of data for higher performance in data access. 
            &quot;&quot;&quot;</span><span class="s2">)</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Technical Requirements:&quot;</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
            - Provide remote access to the VMs (all VMs) for SW installation and configurations. 
            - In case not using dongles, a connection from the VMs to (https://paxaeraultima.net:1435) for PaxeraHealth licensing except the database VM. 
            - **Licensed Operating Systems &amp; Third-Party Components:** Operating systems and all supporting software must be properly licensed and regularly updated to close security gaps and maintain system reliability. 
            &quot;&quot;&quot;</span><span class="s2">)</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Network Requirements:&quot;</span><span class="s2">)</span>
            <span class="s1">network_requirements </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
            - LAN bandwidth to be 1GB dedicated. 
            - Paxera PACS VMs, Paxera Ultima Viewer VMs, Paxera Broker Integration VMs must be in the same vLAN. 
            - 1 Gb/s dedicated bandwidth across the vLAN with the maximum number of two network hops. 
            - Latency less than 1ms. 
            - Site-to-Site VPN with any other connected branch. 
            &quot;&quot;&quot;</span>

            <span class="s5"># Add DMZ recommendation if Referring Physician External Access is enabled</span>
            <span class="s0">if </span><span class="s1">ref_phys_external_access</span><span class="s2">:</span>
                <span class="s1">network_requirements </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
            - Referring Physician Portal VMs must be placed in a **DMZ (Demilitarized Zone) network** to isolate external access from internal hospital systems and enhance security. 
            &quot;&quot;&quot;</span>
            <span class="s0">if </span><span class="s1">patient_portal_external_access</span><span class="s2">:</span>
                <span class="s1">network_requirements </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
            - Patient Portal VMs must be placed in a **DMZ (Demilitarized Zone) network** to isolate external access from internal hospital systems and enhance security. 
            &quot;&quot;&quot;</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">network_requirements</span><span class="s2">)</span>

            <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Minimum Requirements &amp; Recommendations:&quot;</span><span class="s2">)</span>
            <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;&quot;&quot; 
            1. **Antivirus on All Backend Servers (Required):** 
               Every server hosting our software components must have robust, up-to-date antivirus protection. 
            2. **Firewall for External Publishing (Required):** 
               Any system accessible from the internet—such as patient portals, referring physician portals, or tele-radiology services—must be protected by a properly configured firewall. 
            3. **Backup Storage for Secondary Copies (Strongly Recommended):** 
               Implementing a reliable backup strategy ensures a secondary copy of critical patient data and system files, enhancing business continuity and recovery capabilities. 
            4. **Additional Security Measures (Recommended):** 
               - Regular Security Updates &amp; Patches: Keep all systems current with the latest patches. 
               - Multi-Factor Authentication (MFA): Enforce MFA for all administrative and remote access accounts. 
               - Network Segmentation &amp; Isolation: Limit potential breaches by isolating critical systems. 
            5. **Non-Compliance &amp; Customer Responsibility:** 
               Failure to adhere to these guidelines places customers at heightened risk for cyberattacks, including ransomware, data breaches, and service interruptions. If recommended security measures are not implemented, PaxeraHealth cannot be held responsible for any resulting damages or data loss. In such situations, any re-installation, re-implementation, or post-incident remediation will be billed as a separate professional service. 
            6. **Transparency &amp; Long-Term Value:** 
               By openly communicating these requirements and their implications during the pre-sales process, we help customers make informed decisions that safeguard their systems and data. This level of transparency fosters trust, enhances the long-term value of our solutions, and ensures smoother implementations. 
            &quot;&quot;&quot;</span><span class="s2">)</span>

            <span class="s1">mini_pacs_results </span><span class="s2">= []</span>
            <span class="s1">mini_pacs_storage </span><span class="s2">= []</span>
            <span class="s1">mini_pacs_servers </span><span class="s2">= []</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">location </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">mini_pacs_settings</span><span class="s2">):</span>
                <span class="s0">if </span><span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;high_availability&quot;</span><span class="s2">]:</span>
                    <span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;pacs_ccu&quot;</span><span class="s2">] *= </span><span class="s3">2</span>
                    <span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;ris_ccu&quot;</span><span class="s2">] *= </span><span class="s3">2</span>

                <span class="s1">mini_pacs_result</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">mini_pacs_first_year_storage</span><span class="s2">, </span><span class="s1">mini_pacs_total_storage</span><span class="s2">, </span><span class="s1">mini_pacs_vcpu</span><span class="s2">, </span><span class="s1">mini_pacs_ram</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">calculate_vm_requirements</span><span class="s2">(</span>
                    <span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;num_studies&quot;</span><span class="s2">], </span><span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;pacs_ccu&quot;</span><span class="s2">], </span><span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;ris_ccu&quot;</span><span class="s2">], </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">broker_required</span><span class="s2">, </span><span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;broker_level&quot;</span><span class="s2">], </span><span class="s1">num_machines</span><span class="s2">,</span>
                    <span class="s1">contract_duration</span><span class="s2">, </span><span class="s1">study_size_mb</span><span class="s2">, </span><span class="s1">annual_growth_rate</span><span class="s2">, </span><span class="s1">aidocker_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                    <span class="s1">ark_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">ref_phys_external_access</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
                    <span class="s1">training_vm_included</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">high_availability</span><span class="s2">=</span><span class="s1">location</span><span class="s2">[</span><span class="s4">&quot;high_availability&quot;</span><span class="s2">], **</span><span class="s1">modality_cases</span>
                <span class="s2">)</span>
                <span class="s1">mini_pacs_results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">mini_pacs_result</span><span class="s2">)</span>
                <span class="s1">mini_pacs_storage</span><span class="s2">.</span><span class="s1">append</span><span class="s2">({</span>
                    <span class="s4">&quot;first_year&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_first_year_storage</span><span class="s2">,</span>
                    <span class="s4">&quot;total_storage&quot;</span><span class="s2">: </span><span class="s1">mini_pacs_total_storage</span>
                <span class="s2">})</span>
                <span class="s1">mini_pacs_servers</span><span class="s2">.</span><span class="s1">append</span><span class="s2">((</span><span class="s1">mini_pacs_vcpu</span><span class="s2">, </span><span class="s1">mini_pacs_ram</span><span class="s2">))</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">write</span><span class="s2">(</span><span class="s4">f&quot;**Location </span><span class="s0">{</span><span class="s1">i </span><span class="s2">+ </span><span class="s3">2</span><span class="s0">} </span><span class="s4">(Mini PACS)**&quot;</span><span class="s2">)</span>

                <span class="s1">mini_pacs_display_results </span><span class="s2">= </span><span class="s1">mini_pacs_result</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">([</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;RAID 5 (HDD)&quot;</span><span class="s2">])</span>
                <span class="s1">last_index </span><span class="s2">= </span><span class="s1">mini_pacs_display_results</span><span class="s2">.</span><span class="s1">tail</span><span class="s2">(</span><span class="s3">1</span><span class="s2">).</span><span class="s1">index</span>
                <span class="s1">mini_pacs_display_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">last_index</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>
                <span class="s1">mini_pacs_display_results</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s1">last_index</span><span class="s2">, </span><span class="s4">&quot;Other Software&quot;</span><span class="s2">] = </span><span class="s4">&quot;&quot;</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">f&quot;VM Recommendations for </span><span class="s0">{</span><span class="s1">location</span><span class="s2">[</span><span class="s4">'location'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">mini_pacs_display_results</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">apply</span><span class="s2">(</span>
                    <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: [</span><span class="s4">'background-color: yellow' </span><span class="s0">if </span><span class="s4">'Test Environment VM' </span><span class="s0">in </span><span class="s1">x</span><span class="s2">.</span><span class="s1">name </span><span class="s0">else </span><span class="s4">'' </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">x</span><span class="s2">],</span>
                    <span class="s1">axis</span><span class="s2">=</span><span class="s3">1</span><span class="s2">).</span><span class="s1">format</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s3">2</span><span class="s2">))</span>

                <span class="s1">mini_pacs_raid_1_storage_tb </span><span class="s2">= </span><span class="s1">mini_pacs_result</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;RAID 1 (SSD)&quot;</span><span class="s2">, </span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">] / </span><span class="s3">1024</span>
                <span class="s1">mini_pacs_raid_5_storage_tb </span><span class="s2">= </span><span class="s1">mini_pacs_result</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">&quot;RAID 5 (HDD)&quot;</span><span class="s2">, </span><span class="s4">&quot;Storage (GB)&quot;</span><span class="s2">] / </span><span class="s3">1024</span>

                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">f&quot;Storage Requirements for </span><span class="s0">{</span><span class="s1">location</span><span class="s2">[</span><span class="s4">'location'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;**RAID 1 Storage:** </span><span class="s0">{</span><span class="s1">mini_pacs_raid_1_storage_tb</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;**RAID 5 Storage (First Year):** </span><span class="s0">{</span><span class="s1">mini_pacs_storage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">'first_year'</span><span class="s2">] / </span><span class="s3">1024</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;**RAID 5 Storage (Full Contract Duration):** </span><span class="s0">{</span><span class="s1">mini_pacs_storage</span><span class="s2">[</span><span class="s1">i</span><span class="s2">][</span><span class="s4">'total_storage'</span><span class="s2">] / </span><span class="s3">1024</span><span class="s0">:</span><span class="s4">.2f</span><span class="s0">} </span><span class="s4">TB&quot;</span><span class="s2">)</span>

                <span class="s1">mini_pacs_servers </span><span class="s2">= []</span>
                <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">mini_pacs_vcpu</span><span class="s2">, </span><span class="s1">mini_pacs_ram</span>
                <span class="s0">while </span><span class="s1">remaining_threads </span><span class="s2">&gt; </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">remaining_ram </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                    <span class="s0">if </span><span class="s1">remaining_ram </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                        <span class="s1">logging</span><span class="s2">.</span><span class="s1">warning</span><span class="s2">(</span><span class="s4">&quot;No remaining RAM to allocate. Exiting loop.&quot;</span><span class="s2">)</span>
                        <span class="s0">break</span>
                    <span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram </span><span class="s2">= </span><span class="s1">add_server</span><span class="s2">(</span>
                        <span class="s1">mini_pacs_servers</span><span class="s2">, </span><span class="s1">remaining_threads</span><span class="s2">, </span><span class="s1">remaining_ram</span><span class="s2">, </span><span class="s1">max_threads_per_server</span><span class="s2">, </span><span class="s1">max_ram_per_server</span>
                    <span class="s2">)</span>

                <span class="s1">mini_pacs_server_specs </span><span class="s2">= </span><span class="s1">format_server_specs</span><span class="s2">(</span><span class="s1">mini_pacs_servers</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">f&quot;Server Design for </span><span class="s0">{</span><span class="s1">location</span><span class="s2">[</span><span class="s4">'location'</span><span class="s2">]</span><span class="s0">}</span><span class="s4">:&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">mini_pacs_server_specs</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">gateway_locations</span><span class="s2">:</span>
                <span class="s1">gateway_specs </span><span class="s2">= </span><span class="s4">&quot;&quot;&quot; 
                **Recommended Hardware Specifications**   
                - Processor: Intel core i7, Xeon 2.5 GHz or higher processor type.   
                - RAM: 16GB   
                - Storage: 100GB SSD for operating system, 100 GB SSD for imaging data storage (This can be changed based on the retention policy)   
                - Network Interface: Gigabit Ethernet port   
 
                **Software Requirements**   
                - Operating System: Windows 10 or higher, Windows Server 2019 or higher   
                - DB Software: MSSQL 2019 or higher edition (Express edition can be used)   
                - Security Software: Firewall software, antivirus   
 
                **Security Considerations**   
                - Enable secure boot and ensure regular security updates.   
                - Implement role-based access controls for administrative tasks.   
                - Site to Site VPN with the main site.  
 
                **Internet Requirements**   
                - Minimum Required  bandwidth: 30 Mbps   
                - Recommended  bandwidth: 50 Mbps 
                &quot;&quot;&quot;</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Gateway Workstation Specs&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">f&quot;&lt;h4&gt;Gateway Locations: </span><span class="s0">{</span><span class="s4">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">map</span><span class="s2">(</span><span class="s1">str</span><span class="s2">, </span><span class="s1">gateway_locations</span><span class="s2">))</span><span class="s0">}</span><span class="s4">&lt;/h4&gt;&quot;</span><span class="s2">,</span>
                            <span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">gateway_specs</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">gateway_specs </span><span class="s2">= </span><span class="s0">None</span>

                <span class="s5"># Construct Licensing Notes Dynamically</span>
            <span class="s1">licensing_notes </span><span class="s2">= []</span>

            <span class="s5"># Windows Licensing Note</span>
            <span class="s1">licensing_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s4">&quot;- **Windows Server Licensing:** Each VM requires an active Windows Server license. For environments with a Data Center license, these licenses may be unlimited. Verify the licensing model in use.&quot;</span>
            <span class="s2">)</span>

            <span class="s5"># Virtualization Licensing Note (HA-Specific)</span>
            <span class="s0">if </span><span class="s1">high_availability</span><span class="s2">:</span>
                <span class="s1">licensing_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s4">&quot;- **Virtualization Platform Licensing:** Ensure the selected platform (e.g., VMware or Hyper-V) supports High Availability features (e.g., vMotion, Live Migration).&quot;</span>
                <span class="s2">)</span>

            <span class="s5"># Ubuntu Licensing Note (Only if Ubuntu VMs Exist)</span>
            <span class="s0">if </span><span class="s1">ubuntu_vms_count </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">licensing_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                    <span class="s4">&quot;- **Ubuntu Licensing:** Ensure sufficient Ubuntu Server licenses are available for VMs running on Linux.&quot;</span>
                <span class="s2">)</span>

            <span class="s5"># Antivirus Licensing Note</span>
            <span class="s1">licensing_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s4">&quot;- **Antivirus Licensing:** One license per VM is required unless otherwise specified.&quot;</span>
            <span class="s2">)</span>

            <span class="s5"># Backup Software Note</span>
            <span class="s1">licensing_notes</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span>
                <span class="s4">&quot;- **Backup Software:** Ensure compatibility with selected VMs and storage solutions.&quot;</span>
            <span class="s2">)</span>

            <span class="s5"># Combine Licensing Notes into a Single String</span>
            <span class="s1">licensing_notes_text </span><span class="s2">= </span><span class="s4">&quot;</span><span class="s0">\n</span><span class="s4">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">licensing_notes</span><span class="s2">)</span>

            <span class="s5"># Define the DMZ Recommendations</span>
            <span class="s1">dmz_recommendations </span><span class="s2">= </span><span class="s4">&quot;&quot;</span>
            <span class="s0">if </span><span class="s1">ref_phys_external_access</span><span class="s2">:</span>
                <span class="s1">dmz_recommendations </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
                                                       - Referring Physician Portal VMs must be placed in a **DMZ (Demilitarized Zone) network** to isolate external access from internal hospital systems and enhance security. 
                                                   &quot;&quot;&quot;</span>
            <span class="s0">if </span><span class="s1">patient_portal_external_access</span><span class="s2">:</span>
                <span class="s1">dmz_recommendations </span><span class="s2">+= </span><span class="s4">&quot;&quot;&quot; 
                                                       - Patient Portal VMs must be placed in a **DMZ (Demilitarized Zone) network** to isolate external access from internal hospital systems and enhance security. 
                                                   &quot;&quot;&quot;</span>

            <span class="s5"># Define the Notes Dictionary</span>
            <span class="s1">notes </span><span class="s2">= {</span>
                <span class="s4">&quot;licensing_notes&quot;</span><span class="s2">: </span><span class="s1">licensing_notes_text</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(),  </span><span class="s5"># Add dynamically constructed Licensing Notes</span>
                <span class="s4">&quot;sizing_notes&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
                                               - Provided VM sizing of the Virtual servers will be scaled up horizontally or vertically based on the expected volume of data and number of CCUs. 
                                               - SSD Datastore recommended for all OS Virtual disks of all VMs. 
                                               - SSD recommended for the data drive of the Database Server. 
                                               - It's recommended to have SSD storage for the short Term Storage (STS) that keep last 6 month of data for higher performance in data access. 
                                           &quot;&quot;&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;technical_requirements&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
                                               - Provide remote access to the VMs (all VMs) for SW installation and configurations. 
                                               - In case not using dongles, a connection from the VMs to (https://paxaeraultima.net:1435) for PaxeraHealth licensing except the database VM. 
                                           &quot;&quot;&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;network_requirements&quot;</span><span class="s2">: </span><span class="s4">f&quot;&quot;&quot;</span>
                                               <span class="s4">- LAN bandwidth to be 1GB dedicated.</span>
                                               <span class="s4">- Paxera PACS VMs, Paxera Ultima Viewer VMs, Paxera Broker Integration VMs must be in same vLAN.</span>
                                               <span class="s4">- 1 Gb/s dedicated bandwidth across the vLAN with the maximum number of two network hops.</span>
                                               <span class="s4">- Latency less than 1ms.</span>
                                               <span class="s4">- Site to Site VPN with any other connected branch.</span>
                                               <span class="s0">{</span><span class="s1">dmz_recommendations</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span><span class="s0">}</span>
                                           <span class="s4">&quot;&quot;&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;minimum_requirements&quot;</span><span class="s2">: </span><span class="s4">&quot;&quot;&quot; 
                                               - **Antivirus on All Backend Servers (Required):** 
                                                  Every server hosting our software components must have robust, up-to-date antivirus protection. 
                                               - **Firewall for External Publishing (Required):** 
                                                  Any system accessible from the internet—such as patient portals, referring physician portals, or tele-radiology services—must be protected by a properly configured firewall. 
                                               - **Backup Storage for Secondary Copies (Strongly Recommended):** 
                                                  Implementing a reliable backup strategy ensures a secondary copy of critical patient data and system files, enhancing business continuity and recovery capabilities. 
                                               - **Additional Security Measures (Recommended):** 
                                                  - Regular Security Updates &amp; Patches: Keep all systems current with the latest patches. 
                                                  - Multi-Factor Authentication (MFA): Enforce MFA for all administrative and remote access accounts. 
                                                  - Network Segmentation &amp; Isolation: Limit potential breaches by isolating critical systems. 
                                               - **Non-Compliance &amp; Customer Responsibility:** 
                                                  Failure to adhere to these guidelines places customers at heightened risk for cyberattacks, including ransomware, data breaches, and service interruptions. If recommended security measures are not implemented, PaxeraHealth cannot be held responsible for any resulting damages or data loss. In such situations, any re-installation, re-implementation, or post-incident remediation will be billed as a separate professional service. 
                                               - **Transparency &amp; Long-Term Value:** 
                                                  By openly communicating these requirements and their implications during the pre-sales process, we help customers make informed decisions that safeguard their systems and data. This level of transparency fosters trust, enhances the long-term value of our solutions, and ensures smoother implementations. 
                                           &quot;&quot;&quot;</span>
            <span class="s2">}</span>

            <span class="s1">ai_features </span><span class="s2">= []</span>
            <span class="s0">if </span><span class="s1">aidocker_included</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">organ_segmentator</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Organ Segmentator&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_2d</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 2D&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_3d</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 3D&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">speech_to_text_container</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Speech-to-Text Container&quot;</span><span class="s2">)</span>

            <span class="s1">ark_feature </span><span class="s2">= </span><span class="s4">&quot;Included&quot; </span><span class="s0">if </span><span class="s1">ark_included </span><span class="s0">else </span><span class="s4">&quot;Not Included&quot;</span>

            <span class="s5"># Prepare AI-related values for input table</span>
            <span class="s1">ai_features </span><span class="s2">= []</span>
            <span class="s0">if </span><span class="s1">aidocker_included</span><span class="s2">:</span>
                <span class="s0">if </span><span class="s1">organ_segmentator</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Organ Segmentator&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_2d</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 2D&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">lesion_segmentator_3d</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Lesion Segmentator 3D&quot;</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">speech_to_text_container</span><span class="s2">:</span>
                    <span class="s1">ai_features</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Speech-to-Text Container&quot;</span><span class="s2">)</span>

            <span class="s5"># Initialize the base Input and Value lists</span>
            <span class="s1">input_list </span><span class="s2">= []</span>
            <span class="s1">value_list </span><span class="s2">= []</span>

            <span class="s5"># Add items to input_list and value_list conditionally</span>
            <span class="s0">if </span><span class="s1">num_studies </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Number of Studies&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">num_studies</span><span class="s0">:</span><span class="s4">,</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)  </span><span class="s5"># Add comma as thousand separator</span>

            <span class="s0">if </span><span class="s1">num_locations </span><span class="s2">&gt; </span><span class="s3">1</span><span class="s2">:  </span><span class="s5"># Only show if there is more than 1 location</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Number of Locations&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">num_locations</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">num_machines </span><span class="s2">&gt; </span><span class="s3">1</span><span class="s2">:  </span><span class="s5"># Only show if there is more than 1 machine</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Number of Machines&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">num_machines</span><span class="s2">)</span>

            <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Contract Duration (years)&quot;</span><span class="s2">)</span>
            <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">contract_duration</span><span class="s2">)</span>

            <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Study Size (MB)&quot;</span><span class="s2">)</span>
            <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">study_size_mb</span><span class="s2">)</span>

            <span class="s0">if </span><span class="s1">annual_growth_rate </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Annual Growth Rate (%)&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">annual_growth_rate</span><span class="s2">)</span>

            <span class="s5"># Add PACS CCU if &gt; 0</span>
            <span class="s0">if </span><span class="s1">pacs_ccu </span><span class="s0">and </span><span class="s1">pacs_ccu </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;PACS CCU&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">pacs_ccu</span><span class="s2">)</span>

            <span class="s5"># Add RIS CCU if &gt; 0</span>
            <span class="s0">if </span><span class="s1">ris_ccu </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;RIS CCU&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ris_ccu</span><span class="s2">)</span>

            <span class="s5"># Add Referring Physician CCU if &gt; 0</span>
            <span class="s0">if </span><span class="s1">ref_phys_ccu </span><span class="s0">and </span><span class="s1">ref_phys_ccu </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Referring Physician CCU&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ref_phys_ccu</span><span class="s2">)</span>
            <span class="s5"># Broker Logic</span>
            <span class="s0">if </span><span class="s1">broker_level </span><span class="s0">and </span><span class="s1">broker_level </span><span class="s2">!= </span><span class="s4">&quot;Not Required&quot;</span><span class="s2">:  </span><span class="s5"># If broker_level is explicitly selected and not &quot;Not Required&quot;</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Broker VM&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">broker_level</span><span class="s2">)</span>
            <span class="s0">elif </span><span class="s1">ris_ccu </span><span class="s0">and </span><span class="s1">ris_ccu </span><span class="s2">&gt; </span><span class="s3">0</span><span class="s2">:  </span><span class="s5"># If RIS CCU &gt; 0 and broker is not explicitly set</span>
                <span class="s1">broker_level </span><span class="s2">= </span><span class="s4">&quot;WL&quot;  </span><span class="s5"># Default to &quot;WL&quot;</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Broker VM&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">broker_level</span><span class="s2">)</span>
            <span class="s5"># If broker_level is &quot;Not Required&quot; and RIS CCU is 0, do not add Broker VM to the table</span>

            <span class="s5"># Conditionally add AI Features if any are selected</span>
            <span class="s0">if </span><span class="s1">ai_features</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;AI Features&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">ai_features</span><span class="s2">))</span>

            <span class="s5"># Conditionally add ARKAI if it's included</span>
            <span class="s0">if </span><span class="s1">ark_included</span><span class="s2">:</span>
                <span class="s1">input_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;ARKAI&quot;</span><span class="s2">)</span>
                <span class="s1">value_list</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">&quot;Included&quot;</span><span class="s2">)</span>

            <span class="s5"># Construct the input values DataFrame</span>
            <span class="s1">input_values </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                <span class="s4">&quot;Input&quot;</span><span class="s2">: </span><span class="s1">input_list</span><span class="s2">,</span>
                <span class="s4">&quot;Value&quot;</span><span class="s2">: </span><span class="s1">value_list</span>
            <span class="s2">})</span>

            <span class="s5"># Initialize Workstation Specifications</span>
            <span class="s1">diagnostic_specs </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">viewing_specs </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">ris_specs </span><span class="s2">= </span><span class="s0">None</span>

            <span class="s0">if </span><span class="s1">include_workstation_specs</span><span class="s2">:</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">subheader</span><span class="s2">(</span><span class="s4">&quot;Workstation Specifications&quot;</span><span class="s2">)</span>

                <span class="s1">diagnostic_specs </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                    <span class="s4">&quot;Item&quot;</span><span class="s2">: [</span>
                        <span class="s4">&quot;Processor&quot;</span><span class="s2">, </span><span class="s4">&quot;Memory Capacity&quot;</span><span class="s2">, </span><span class="s4">&quot;Hard Drives&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Internal Optical Drive&quot;</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Medical Grade Monitor&quot;</span><span class="s2">, </span><span class="s4">&quot;Monitor&quot;</span><span class="s2">, </span><span class="s4">&quot;Graphics&quot;</span>
                    <span class="s2">],</span>
                    <span class="s4">&quot;Description&quot;</span><span class="s2">: [</span>
                        <span class="s4">&quot;Intel Core i7 (6C, 12M Cache, base 3.1GHz, up to 4.5GHz)&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;16 GB, 2 x 8 GB, DDR5, 4400 MT/s, V2&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;512GB PCIe NVMe Class 40 M.2 SSD&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;8x DVD+/-RW 9.5mm Optical Disk Drive&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Windows 10 Pro English&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;3MP (5MP for Mammo) color high brightness single head&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;24” LCD color monitor&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Dedicated GPU with at least 4GB VRAM&quot;</span>
                    <span class="s2">]</span>
                <span class="s2">})</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### Diagnostic Workstation&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">diagnostic_specs</span><span class="s2">)</span>

                <span class="s5"># Viewing Workstation Table</span>
                <span class="s1">viewing_specs </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                    <span class="s4">&quot;Item&quot;</span><span class="s2">: [</span>
                        <span class="s4">&quot;Processor&quot;</span><span class="s2">, </span><span class="s4">&quot;Memory Capacity&quot;</span><span class="s2">, </span><span class="s4">&quot;Hard Drives&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Internal Optical Drive&quot;</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Monitor&quot;</span>
                    <span class="s2">],</span>
                    <span class="s4">&quot;Description&quot;</span><span class="s2">: [</span>
                        <span class="s4">&quot;Intel Core i5 (6C, 12M Cache, base 3.1GHz, up to 4.5GHz)&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;1 x 8 GB, DDR5, 4400 MT/s, V2&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;256GB PCIe NVMe Class 40 M.2 SSD&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;8x DVD+/-RW 9.5mm Optical Disk Drive&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;Windows 10 Pro English&quot;</span><span class="s2">,</span>
                        <span class="s4">&quot;24” LCD color monitor&quot;</span>
                    <span class="s2">]</span>
                <span class="s2">})</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### PACS Viewing Workstation&quot;</span><span class="s2">)</span>
                <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">viewing_specs</span><span class="s2">)</span>

                <span class="s5"># RIS Workstation Table</span>
                <span class="s0">if </span><span class="s1">ris_enabled</span><span class="s2">:</span>
                    <span class="s1">ris_specs </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">DataFrame</span><span class="s2">({</span>
                        <span class="s4">&quot;Item&quot;</span><span class="s2">: [</span>
                            <span class="s4">&quot;Processor&quot;</span><span class="s2">, </span><span class="s4">&quot;Memory Capacity&quot;</span><span class="s2">, </span><span class="s4">&quot;Hard Drives&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;Internal Optical Drive&quot;</span><span class="s2">, </span><span class="s4">&quot;Operating System&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;Monitor&quot;</span>
                        <span class="s2">],</span>
                        <span class="s4">&quot;Description&quot;</span><span class="s2">: [</span>
                            <span class="s4">&quot;10th Generation Intel® Core™ i5, 6 Cores, 12MB Cache, 3.2GHz&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;8GB 1 x 8GB DDR4-2666MHz&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;256GB PCIe NVMe Class 40 M.2 SSD (3.5 inch)&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;8x DVD+/-RW 9.5mm Optical Disk Drive&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;Windows 10 Pro English&quot;</span><span class="s2">,</span>
                            <span class="s4">&quot;24” LCD color monitor&quot;</span>
                        <span class="s2">]</span>
                    <span class="s2">})  </span><span class="s5"># Set &quot;Item&quot; as the index</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s4">&quot;### RIS Workstation&quot;</span><span class="s2">)</span>
                    <span class="s1">st</span><span class="s2">.</span><span class="s1">dataframe</span><span class="s2">(</span><span class="s1">ris_specs</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">high_availability</span><span class="s2">:</span>
            <span class="s1">physical_design_string </span><span class="s2">= </span><span class="s4">&quot;High Availability Server Design:</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s1">server_specs</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">physical_design_string </span><span class="s2">= </span><span class="s4">&quot;Standard Server Design:</span><span class="s0">\n</span><span class="s4">&quot; </span><span class="s2">+ </span><span class="s1">server_specs</span>
        <span class="s5"># Determine shared storage type</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">servers</span><span class="s2">) == </span><span class="s3">1 </span><span class="s0">and not </span><span class="s1">high_availability</span><span class="s2">:</span>
            <span class="s1">shared_storage </span><span class="s2">= </span><span class="s4">&quot;Built-in Storage&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">shared_storage </span><span class="s2">= </span><span class="s4">&quot;Shared DAS/SAN Storage&quot;</span>

        <span class="s1">doc </span><span class="s2">= </span><span class="s1">generate_document_from_template</span><span class="s2">(</span>
            <span class="s1">template_path</span><span class="s2">=</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">app_dir</span><span class="s2">, </span><span class="s4">&quot;assets&quot;</span><span class="s2">, </span><span class="s4">&quot;templates&quot;</span><span class="s2">, </span><span class="s4">&quot;Temp.docx&quot;</span><span class="s2">),</span>
            <span class="s1">results</span><span class="s2">=</span><span class="s1">results</span><span class="s2">,</span>
            <span class="s1">results_grade1</span><span class="s2">=</span><span class="s1">results_grade1</span><span class="s2">,</span>
            <span class="s1">results_grade3</span><span class="s2">=</span><span class="s1">results_grade3</span><span class="s2">,</span>
            <span class="s1">df_comparison</span><span class="s2">=</span><span class="s1">df_comparison</span><span class="s2">,</span>
            <span class="s1">third_party_licenses</span><span class="s2">=</span><span class="s1">third_party_licenses</span><span class="s2">,</span>
            <span class="s1">notes</span><span class="s2">=</span><span class="s1">notes</span><span class="s2">,</span>
            <span class="s1">input_table</span><span class="s2">=</span><span class="s1">input_values</span><span class="s2">,</span>
            <span class="s1">customer_name</span><span class="s2">=</span><span class="s1">customer_name</span><span class="s2">,</span>
            <span class="s1">high_availability</span><span class="s2">=</span><span class="s1">high_availability</span><span class="s2">,</span>
            <span class="s1">server_specs</span><span class="s2">=</span><span class="s1">server_specs</span><span class="s2">,  </span><span class="s5"># Updated production server specs</span>
            <span class="s1">gpu_specs</span><span class="s2">=</span><span class="s1">gpu_specs</span><span class="s2">,</span>
            <span class="s1">first_year_storage_raid5</span><span class="s2">=</span><span class="s1">first_year_storage_raid5</span><span class="s2">,</span>
            <span class="s1">total_image_storage_raid5</span><span class="s2">=</span><span class="s1">total_image_storage_raid5</span><span class="s2">,</span>
            <span class="s1">num_studies</span><span class="s2">=</span><span class="s1">num_studies</span><span class="s2">,</span>
            <span class="s1">storage_title</span><span class="s2">=</span><span class="s1">storage_type</span><span class="s2">,</span>
            <span class="s1">shared_storage</span><span class="s2">=</span><span class="s1">shared_storage</span><span class="s2">,</span>
            <span class="s1">raid_1_storage_tb</span><span class="s2">=</span><span class="s1">raid_1_storage_tb</span><span class="s2">,</span>
            <span class="s1">gateway_specs</span><span class="s2">=</span><span class="s1">gateway_specs</span><span class="s2">,</span>
            <span class="s1">diagnostic_specs</span><span class="s2">=</span><span class="s1">diagnostic_specs</span><span class="s2">,</span>
            <span class="s1">viewing_specs</span><span class="s2">=</span><span class="s1">viewing_specs</span><span class="s2">,</span>
            <span class="s1">ris_specs</span><span class="s2">=</span><span class="s1">ris_specs</span><span class="s2">,</span>
            <span class="s1">project_grade</span><span class="s2">=</span><span class="s1">project_grade</span><span class="s2">,</span>
            <span class="s1">storage_table</span><span class="s2">=</span><span class="s1">storage_table</span><span class="s2">,</span>
            <span class="s1">physical_design</span><span class="s2">=</span><span class="s1">physical_design_string</span><span class="s2">,</span>
            <span class="s1">nas_backup_details</span><span class="s2">=</span><span class="s1">nas_backup_string</span><span class="s2">,</span>
            <span class="s1">tier_2_disks</span><span class="s2">=</span><span class="s1">tier_2_disks</span><span class="s2">,</span>
            <span class="s1">tier_2_disk_size</span><span class="s2">=</span><span class="s1">tier_2_disk_size</span><span class="s2">,</span>
            <span class="s1">tier_3_disks</span><span class="s2">=</span><span class="s1">tier_3_disks</span><span class="s2">,</span>
            <span class="s1">tier_3_disk_size</span><span class="s2">=</span><span class="s1">tier_3_disk_size</span><span class="s2">,</span>
            <span class="s1">additional_vm_table</span><span class="s2">=</span><span class="s1">additional_vms_table</span><span class="s2">,  </span><span class="s5"># Pass additional VMs as a DataFrame</span>
            <span class="s1">additional_vm_notes</span><span class="s2">=</span><span class="s1">additional_vm_notes</span><span class="s2">,  </span><span class="s5"># Notes for additional VMs</span>
            <span class="s1">general_notes</span><span class="s2">=</span><span class="s1">general_notes</span><span class="s2">,  </span><span class="s5"># General notes applicable to all VMs</span>
            <span class="s1">additional_servers</span><span class="s2">=</span><span class="s1">additional_servers</span><span class="s2">,</span>
            <span class="s1">additional_vms</span><span class="s2">=</span><span class="s1">additional_vms</span><span class="s2">,</span>
            <span class="s1">additional_requirements_table</span><span class="s2">=</span><span class="s1">additional_requirements_table  </span><span class="s5"># Pass additional requirements table</span>
        <span class="s2">)</span>

        <span class="s1">download_link </span><span class="s2">= </span><span class="s1">get_binary_file_downloader_html</span><span class="s2">(</span>
            <span class="s1">doc</span><span class="s2">,</span>
            <span class="s1">file_label</span><span class="s2">=</span><span class="s4">&quot;Download Word Document&quot;</span><span class="s2">,</span>
            <span class="s1">customer_name</span><span class="s2">=</span><span class="s1">customer_name</span><span class="s2">,</span>
            <span class="s1">file_extension</span><span class="s2">=</span><span class="s4">&quot;.docx&quot;</span>
        <span class="s2">)</span>
        <span class="s1">st</span><span class="s2">.</span><span class="s1">markdown</span><span class="s2">(</span><span class="s1">download_link</span><span class="s2">, </span><span class="s1">unsafe_allow_html</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s4">&quot;__main__&quot;</span><span class="s2">:</span>
    <span class="s1">main</span><span class="s2">()</span>
</pre>
</body>
</html>